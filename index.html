<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Genel Bakım Sistemi – V10 Enterprise</title>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* ============================================================
        V10 ENTERPRISE - GLOBAL THEME
    ============================================================ */
    :root {
      --bg: #0b1220;
      --card: #0f172a;
      --card2: #0b1220;
      --border: #1f2a44;
      --border2: #2b3a5f;
      --text: #e7eefc;
      --muted: #9bb0d3;
      --muted2: #7d93bb;
      --indigo: #4f46e5;
      --indigo2: #6366f1;
      --green: #16a34a;
      --green2: #22c55e;
      --danger: #ef4444;
      --warn: #f59e0b;
    }
    html, body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Montserrat', sans-serif;
      -webkit-tap-highlight-color: transparent;
    }
    .card {
      background: linear-gradient(180deg, rgba(15,23,42,1) 0%, rgba(11,18,32,1) 100%);
      border: 1px solid var(--border);
      box-shadow: 0 18px 60px rgba(0,0,0,0.35);
    }
    .topbar {
      background: linear-gradient(90deg, var(--indigo) 0%, var(--indigo2) 100%);
      height: 6px;
      border-radius: 999px;
      opacity: 0.95;
    }
    .label {
      font-weight: 800;
      font-size: 0.70rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      margin-bottom: 6px;
      display: block;
    }
    .input {
      background: rgba(15,23,42,0.8);
      border: 1px solid var(--border2);
      color: var(--text);
      transition: 0.2s;
      border-radius: 16px;
      padding: 14px 16px;
      width: 100%;
      outline: none;
      font-weight: 700;
    }
    .input::placeholder {
      color: rgba(155,176,211,0.55);
      font-weight: 600;
    }
    .input:focus {
      border-color: rgba(99,102,241,0.9);
      box-shadow: 0 0 0 4px rgba(99,102,241,0.15);
    }
    .chip {
      border: 1px solid var(--border2);
      background: rgba(11,18,32,0.65);
      padding: 10px 12px;
      border-radius: 16px;
      font-weight: 800;
      font-size: 0.78rem;
      cursor: pointer;
      user-select: none;
      transition: 0.25s;
      text-align: center;
    }
    input[type="radio"].sr-only:checked + .chip {
      border-color: rgba(129,140,248,0.9);
      background: rgba(79,70,229,0.95);
      color: white;
      box-shadow: 0 10px 30px rgba(79,70,229,0.20);
    }
    .btn {
      width: 100%;
      padding: 16px 16px;
      border-radius: 18px;
      font-weight: 900;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      transition: 0.25s;
    }
    .btn-primary {
      background: linear-gradient(90deg, var(--indigo) 0%, var(--indigo2) 100%);
      color: white;
    }
    .btn-primary:hover { opacity: 0.95; transform: translateY(-1px); }
    .btn-green {
      background: linear-gradient(90deg, var(--green) 0%, var(--green2) 100%);
      color: white;
    }
    .btn-green:hover { opacity: 0.95; transform: translateY(-1px); }

    .panel {
      background: rgba(11,18,32,0.55);
      border: 1px solid var(--border2);
      border-radius: 18px;
      padding: 14px;
    }
    .mono { font-feature-settings: "ss01"; letter-spacing: 0.08em; }
    .hint {
      color: rgba(155,176,211,0.75);
      font-weight: 600;
      font-size: 0.85rem;
      line-height: 1.45rem;
    }
    .divider {
      border-top: 1px solid rgba(43,58,95,0.6);
      margin: 18px 0;
    }

    /* Loading overlay */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    .overlay-card {
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(43,58,95,0.85);
      border-radius: 22px;
      padding: 18px 18px;
      width: min(540px, 100%);
      box-shadow: 0 30px 90px rgba(0,0,0,0.55);
    }
    .spinner {
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: 4px solid rgba(99,102,241,0.20);
      border-top-color: rgba(99,102,241,0.95);
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Output area */
    .output {
      white-space: pre-wrap;
      line-height: 1.9rem;
      font-size: 0.95rem;
      font-weight: 650;
      background: rgba(2,6,23,0.65);
      border: 1px solid rgba(43,58,95,0.85);
      border-radius: 18px;
      padding: 16px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02);
    }

    select.input { padding-right: 42px; }

    @media (max-width: 640px) {
      .btn { padding: 15px 14px; }
      .input { padding: 13px 14px; }
    }
  </style>
</head>

<body class="min-h-screen flex items-center justify-center p-4">

  <!-- ============================================================
        V10 ENTERPRISE - MAIN APP
  ============================================================ -->
  <div class="w-full max-w-3xl card rounded-3xl p-5 md:p-10 relative">
    <div class="topbar w-full mb-6"></div>

    <h1 class="text-xl md:text-2xl font-black text-center uppercase italic">
      Genel Bakım Analiz Sistemi
    </h1>
    <p class="hint text-center mt-2">
      Bilgileri girin, WhatsApp konuşmasını yapıştırın, sistem konuşmayı analiz edip uzun ve tek parça bakım metnini üretir.
      Metnin içine teknik detay sızdırılmaz. Çıktı doğrudan WhatsApp’a uygundur.
    </p>

    <div class="divider"></div>

    <!-- Hitap -->
    <div class="grid grid-cols-2 gap-3">
      <div>
        <span class="label">Hitap</span>
        <div class="grid grid-cols-2 gap-3">
          <label class="cursor-pointer">
            <input class="sr-only" type="radio" name="hitap" value="Hanım" checked>
            <div class="chip">KADIN (HANIM)</div>
          </label>
          <label class="cursor-pointer">
            <input class="sr-only" type="radio" name="hitap" value="Bey">
            <div class="chip">ERKEK (BEY)</div>
          </label>
        </div>
      </div>

      <div>
        <span class="label">Çıktı Modu</span>
        <select id="mode" class="input font-extrabold text-indigo-200">
          <option value="enterprise_ultra" selected>V10 Enterprise Ultra (5000+ karakter)</option>
          <option value="enterprise_max">V10 Enterprise Max (7000+ karakter)</option>
        </select>
      </div>
    </div>

    <div class="divider"></div>

    <!-- Names -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <span class="label">Danışan Adı</span>
        <input id="isim" class="input uppercase" placeholder="Örn: Saadet">
      </div>
      <div>
        <span class="label">Danışan Anne Adı</span>
        <input id="anne" class="input uppercase" placeholder="Örn: Ayşe">
      </div>
    </div>

    <!-- Counterpart -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
      <div>
        <span class="label">Muhatap Adı (Eş/Sevgili/Nişanlı)</span>
        <input id="karsi" class="input uppercase" placeholder="Örn: Edip">
      </div>
      <div>
        <span class="label">Muhatap Anne Adı</span>
        <input id="kAnne" class="input uppercase" placeholder="Örn: Mine">
      </div>
    </div>

    <div class="divider"></div>

    <!-- Work type -->
    <div>
      <span class="label">Konu / Talep (Seçim)</span>
      <select id="talep" class="input font-extrabold text-indigo-200">
        <option value="auto" selected>Otomatik (Konuşmaya göre belirle)</option>
        <option value="iliski">İlişki / Geri Dönüş / Toparlanma</option>
        <option value="bag">Bağ Sabitleme / Kararsızlık</option>
        <option value="aile">Aile Engeli / Hane Direnci</option>
        <option value="rizik">Rızık / İş / Bereket</option>
        <option value="kismet">Kısmet / Evlilik</option>
      </select>
      <p class="hint mt-2">
        Otomatik modda sistem WhatsApp konuşmasındaki ifadelerle en uygun büyü türünü kendisi seçer. İsterseniz manuel de seçebilirsiniz.
      </p>
    </div>

    <div class="divider"></div>

    <!-- WhatsApp log -->
    <div>
      <span class="label">WhatsApp Konuşması / Belirtiler (Yapıştır)</span>
      <textarea id="log" rows="6" class="input text-sm font-semibold" placeholder="Konuşmayı buraya yapıştırın..."></textarea>
      <p class="hint mt-2">
        Konuşma analiz edilir; ancak “anahtar kelimeler” gibi teknik satırlar metne asla eklenmez. Çıktı tek parça WhatsApp metnidir.
      </p>
    </div>

    <div class="divider"></div>

    <!-- WhatsApp send -->
    <div class="panel">
      <span class="label text-green-300">WhatsApp Gönderim (Opsiyonel)</span>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input id="tel" class="input text-center font-black text-xl mono" placeholder="5xx xxx xx xx">
        <button id="btnWhatsApp" class="btn btn-green" onclick="sendWhatsApp()" type="button">
          WhatsApp ile Gönder
        </button>
      </div>
      <p class="hint mt-2">
        Numara girerseniz o numaraya, girmezseniz WhatsApp paylaşım ekranına yönlendirir.
      </p>
    </div>

    <div class="divider"></div>

    <!-- Action -->
    <button id="btnGenerate" class="btn btn-primary" onclick="generate()" type="button">
      Bakım Metnini Oluştur
    </button>

    <!-- Output -->
    <div id="resultWrap" class="mt-6 hidden">
      <div class="panel">
        <div class="flex items-center justify-between gap-3">
          <div>
            <div class="font-black uppercase">Üretilen Metin</div>
            <div class="hint">Bu metin tek parça WhatsApp çıktısıdır. Kopyalayıp yapıştırabilirsiniz.</div>
          </div>
          <button class="px-4 py-3 rounded-2xl font-black bg-slate-800 hover:bg-slate-700 transition" type="button" onclick="copyText()">
            Kopyala
          </button>
        </div>
        <div class="divider"></div>
        <div id="output" class="output"></div>
      </div>
    </div>
  </div>

  <!-- Overlay -->
  <div id="overlay" class="overlay">
    <div class="overlay-card">
      <div class="flex items-center gap-4">
        <div class="spinner"></div>
        <div>
          <div class="font-black text-lg">Analiz yapılıyor...</div>
          <div id="overlayMsg" class="hint mt-1">
            Konuşma akışı okunuyor, konu sınıflandırılıyor ve kişiye özel metin hazırlanıyor.
          </div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="hint">
        Bu ekran sadece kullanıcı deneyimi içindir. Metin üretimi tek seferde yapılır ve sonuç ekrana yazılır.
      </div>
    </div>
  </div>

  <script>
    /* ============================================================
        V10 ENTERPRISE - CORE UTILITIES
    ============================================================ */
    function $(id){ return document.getElementById(id); }
    function safeTrim(v){ return (v || "").toString().trim(); }
    function toUpperTr(s){ return safeTrim(s).toLocaleUpperCase("tr-TR"); }
    function toTitleTr(s){
      s = safeTrim(s);
      if(!s) return "";
      const low = s.toLocaleLowerCase("tr-TR");
      return low.charAt(0).toLocaleUpperCase("tr-TR") + low.slice(1);
    }
    function getHitap(){
      const v = document.querySelector('input[name="hitap"]:checked');
      return v ? v.value : "Hanım";
    }
    function normalizePhone(raw){
      const n = (raw || "").replace(/\D/g, "");
      if(!n) return "";
      if(n.startsWith("90") && n.length >= 12) return n;
      if(n.startsWith("0") && n.length >= 11) return "90" + n.slice(1);
      if(n.startsWith("5") && n.length >= 10) return "90" + n;
      return n;
    }

    function openWa(phone, text){
      const url = phone && phone.length >= 10
        ? `https://wa.me/${phone}?text=${encodeURIComponent(text)}`
        : `https://wa.me/?text=${encodeURIComponent(text)}`;
      window.open(url, "_blank");
    }

    function copyText(){
      const t = safeTrim($("output").innerText);
      if(!t){ alert("Kopyalanacak metin yok."); return; }
      navigator.clipboard.writeText(t);
      alert("Metin kopyalandı.");
    }
    function sendWhatsApp(){
      const t = safeTrim($("output").innerText);
      if(!t){ alert("Önce metni oluşturun."); return; }
      const p = normalizePhone($("tel").value);
      openWa(p, t);
    }

    /* ============================================================
        V10 ENTERPRISE - LOG ANALYSIS
    ============================================================ */
    function analyzeLog(raw){
      const log = safeTrim(raw);
      const low = log.toLocaleLowerCase("tr-TR");
      const sig = {
        hasMoney: /borç|icra|kredi|para|masraf|geçinem|kir(a|ayı)|fatura|iş bulam|maaş|kazanç|bereket|rızık|dükkan|satış|gelir|harc/.test(low),
        hasImmigration: /vatandaşlık|oturum|başvur|dosya|evrak|mahkeme|randevu|konsolos|vize/.test(low),
        hasCooling: /soğud|soğuma|uzaklaşt|konuşmuyo|mesaj atmad|görüşmüyo|engell|beni istemiyo|benden başkas|göz(ü|u) görm|kop|ayr(ı|i)ld|terk etti|boşan/.test(low),
        hasThird: /dedikodu|söz taşı|fitne|araya gir|kıskan|başka biri|kaynana|arkadaş dolduruş|aile dolduruş|laf/.test(low),
        hasFamily: /annem|babam|abla|abi|aile|karşı çık|izin vermiyo|evlenmeme|hane|evde huzursuz|eve gelmiyo/.test(low),
        hasIndecision: /kararsız|gelgit|bir gün iyi bir gün kötü|dün böyle bugün böyle|net değil|karar veremiyo/.test(low),
        hasFear: /kabus|uykusuz|içim daral|kalbim sıkış|panik|ağlama/.test(low)
      };
      const themes = [];
      if(sig.hasMoney) themes.push("maddi sıkışma ve bereket tıkanıklığı");
      if(sig.hasImmigration) themes.push("evrak/dosya tıkanıklığı ve bekleme yükü");
      if(sig.hasCooling) themes.push("soğuma, kopuş ve iletişimde kesilme");
      if(sig.hasThird) themes.push("araya giren söz ve yön saptırma");
      if(sig.hasFamily) themes.push("aile etkisi ve hane içi direnç");
      if(sig.hasIndecision) themes.push("kararsızlık ve gelgit hali");
      if(sig.hasFear) themes.push("iç sıkıntısı ve gece huzursuzluğu");
      return { raw: log, sig, themes: themes.length ? themes : ["genel tıkanıklık ve yön kaybı"] };
    }

    /* ============================================================
        V10 ENTERPRISE - SPELL DECISION ENGINE
    ============================================================ */
    const SPELL_POOL = {
      fitne_sogutma: { name: "Fitne ve Soğutma Harmanı", domain: "iliski" },
      aile_engeli:   { name: "Ev-Eşik Serpiştirme (Aile Engeli) Büyüsü", domain: "aile" },
      rizik_kapama:  { name: "Rızık Kapama ve Bereket Düğümü", domain: "rizik" },
      kismet_kapama: { name: "Kısmet ve Evlilik Yolunu Kapama Büyüsü", domain: "kismet" },
      karar_zayif:   { name: "Karar Zayıflatma ve Niyet Dağıtma Büyüsü", domain: "bag" },
      yol_baglama:   { name: "Yol Bağlama (İş–Evrak Kilidi)", domain: "rizik" },
      sogutma_ayirma:{ name: "Ayırma ve Soğutma Büyüsü", domain: "iliski" }
    };

    function decideSpell(talep, analysis){
      const s = analysis.sig;
      if(talep === "rizik"){
        if(s.hasImmigration) return SPELL_POOL.yol_baglama;
        return SPELL_POOL.rizik_kapama;
      }
      if(talep === "aile") return SPELL_POOL.aile_engeli;
      if(talep === "kismet") return SPELL_POOL.kismet_kapama;
      if(talep === "bag") return SPELL_POOL.karar_zayif;
      if(talep === "iliski"){
        if(s.hasThird) return SPELL_POOL.fitne_sogutma;
        if(s.hasCooling) return SPELL_POOL.sogutma_ayirma;
        return SPELL_POOL.karar_zayif;
      }
      if(s.hasMoney && s.hasImmigration) return SPELL_POOL.yol_baglama;
      if(s.hasFamily) return SPELL_POOL.aile_engeli;
      if(s.hasMoney) return SPELL_POOL.rizik_kapama;
      if(s.hasThird) return SPELL_POOL.fitne_sogutma;
      if(s.hasCooling) return SPELL_POOL.sogutma_ayirma;
      if(s.hasIndecision) return SPELL_POOL.karar_zayif;
      return SPELL_POOL.fitne_sogutma;
    }

    /* ============================================================
        V10 ENTERPRISE - ENHANCED NON-REPEAT ENGINE
    ============================================================ */
    function buildEnterpriseExtension(needChars) {
      const extensionPool = [
        "Şunu da net söyleyeyim: Bu tür düğümler insanın sabrını ve psikolojisini yorar; kişi bir yandan sonucu isterken bir yandan da ‘neden olmuyor’ diye kendini yıpratır. Burada önemli olan, düğümü doğru yerden çözmek ve süreci disiplinli yürütmektir. Disiplin bozulduğunda düğüm kendini tekrar eder; disiplin korununca çözüm hızlanır.",
        "Süreçte çoğu kişi şu hataya düşer: Bir gün umutlanır, ertesi gün morali bozulur; bu gelgit niyeti zayıflatır. Oysa böyle vakalarda en hızlı ilerleme, niyetin tek çizgide sabit kalmasıyla gelir. Siz net kaldığınızda karşı taraftaki tavır da netleşmeye başlar; çünkü düğüm çözülürken ilk değişim genelde konuşma dilinde olur.",
        "Manevi denge sağlandığında, kişi üzerindeki o ağır baskının kalktığını hissetmeye başlar. Bu hafifleme hissi aslında doğru yolda olduğumuzun en büyük kanıtıdır. Unutmayın ki, her karanlık dönemin bir aydınlığa çıkışı vardır ve bu aydınlık, sizin kararlılığınızla mühürlenir.",
        "Çoğu zaman olayları sadece görünen yüzüyle değerlendiririz ama arka planda dönen enerji akışı çok daha farklıdır. Bizim amacımız bu görünmez engelleri bertaraf ederek akışı normale döndürmektir. Bu yapıldığında, daha önce imkansız gibi görünen kapıların kendiliğinden aralandığını göreceksiniz.",
        "Bakım süreci boyunca sabır en büyük yoldaşınız olmalıdır. Aceleci davranmak ve sürekli sonuç beklemek niyetin saflığını bozabilir. Teslimiyet içinde kalmak ve her günün getirdiği küçük değişimlere odaklanmak, büyük mucizenin anahtarıdır.",
        "Düğümler çözülürken bazen eski mevzular tekrar gündeme gelebilir, bu bir temizlik sürecidir. Toz kalkmadan oda temizlenmez. Bu yüzden sürtüşmelere takılmadan, nihai ferahlığa odaklanarak yürümek gerekir.",
        "Zihin sürekli ‘nasıl olacak’ sorusunu sorar ama maneviyat ‘nasıl olacağını değil, olacağına inanmanı’ ister. Biz teknik kısmını yürütürken siz de inanç kısmını sağlam tutmalısınız. Bu iki güç birleştiğinde karşısında durabilecek bir mühür yoktur.",
        "Daha önce benzer tıkanıklıklar yaşayan birçok danışanımda gördüğüm şudur: En büyük değişim, kişinin olaylara bakış açısının değiştiği anda başlar. Enerji değişince çevre de değişir.",
        "Burada yapılan her okuma, sizin niyetinizi evrensel bir frekansta sabitler. Bu frekans bir kez yakalandığında, karşı tarafın ya da olayların bu enerjiye direnmesi mümkün olmaz.",
        "Hayatınızdaki bu tıkanıklık aslında yeni bir başlangıç için yer açma sürecidir. Kırılan dökülen ne varsa, daha sağlam bir yapı kurmak için temizleniyor gibi düşünün.",
        "Sistemin enerjisi bir kez oturduğunda, karşı tarafın iradesi üzerindeki baskı kalkar ve kalbindeki asıl muhabbet nuru yeniden parlamaya başlar. Bu andan itibaren geri dönüşler sadece bir zaman meselesi haline gelir.",
        "Bakım sonuçları bazen rüyalar yoluyla da size sinyal verebilir. Gece uykunuzun daha derinleşmesi veya daha huzurlu uyanmanız, üzerinizdeki ağır negatif enerjinin dağıldığını gösteren ilk fiziksel işaretlerdendir.",
        "Birçok kişi bu tür çalışmaları bir sihirli değnek gibi görür ancak asıl sihir, ilim ve teslimiyetin birleştiği o ince çizgidedir. Biz ilmimizi icra ederken siz de ferahlığınızı koruyarak bu kapıyı açık tutmalısınız.",
        "İlişkideki veya işteki o kopukluk hali, aslında ruhların birbirine olan ihtiyacının üzerini örten yapay bir perdedir. Bu perde kalktığında, her şey sanki hiç bozulmamış gibi doğal bir akışa kavuşur.",
        "Sürecin 7 günlük periyodu rastgele bir seçim değildir; bu süre mühürlerin tabaka tabaka soyulması ve ruhun yeni frekansa uyum sağlaması için gerekli olan manevi döngüdür.",
        "Hiçbir mühür sonsuza kadar sürmez; özellikle de niyet sahiplenilip doğru bir el ile müdahale edildiğinde. Karanlık her zaman ışığa yenilmeye mahkumdur ve bugün sizin için o ışık yanmıştır.",
        "Özellikle 3. günden itibaren muhatabınızda ani bir sessizlik veya garip bir durgunluk görürseniz şaşırmayın; bu, iradenin üzerindeki baskının çözülürken oluşturduğu içsel bir hesaplaşma evresidir.",
        "Kalbinizi şüphelerden arındırın. Çünkü şüphe, açılmaya başlayan kapıya vurulan yeni bir kilit gibidir. Ferah kalın, sürece güvenin ve sonucun ne kadar muazzam olacağını hayal edin.",
        "Bu manevi yolculukta sizin sessizliğiniz ve gizliliğiniz çok önemlidir. Yapılan çalışmayı başkalarıyla paylaşmak enerjiyi dağıtır. Sır, bu işin en büyük koruyucusudur.",
        "Sonuca ulaştığımızda göreceksiniz ki, tüm bu yaşananlar aslında bağın daha da güçlenmesi ve daha köklü bir yapıya kavuşması için yaşanan bir sınavdan ibaretti."
      ];
      
      let out = "";
      let availableIndexes = extensionPool.map((_, i) => i);
      // Shuffle array
      for (let i = availableIndexes.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [availableIndexes[i], availableIndexes[j]] = [availableIndexes[j], availableIndexes[i]];
      }

      let count = 0;
      while (out.length < needChars && count < availableIndexes.length) {
        out += (out ? "\n\n" : "") + extensionPool[availableIndexes[count]];
        count++;
      }
      return out.trim();
    }

    function enforceMinChars(text, mode){
      const min = (mode === "enterprise_max") ? 3800 : 2600;
      let out = text.trim();
      if(out.length < min){
        const need = min - out.length;
        out += "\n\n" + buildEnterpriseExtension(need);
      }
      return out;
    }

    /* ============================================================
        V10 ENTERPRISE - TEMPLATE SYSTEM
    ============================================================ */
    function sentenceJoin(arr){ return arr.filter(Boolean).join(" "); }

    function buildNoOtherHocaNote(){
      return "Önemli bir not: Bu süreçte niyetin tek elden ve tek çizgide yürümesi esastır. Başka bir uygulama ile niyetlerin çakışması toparlanmayı geciktirebilir; bu yüzden tek bir odağa odaklanmak en hayırlısıdır.";
    }

    function buildProcessBlock(){
      return "İzleyeceğimiz yol haritası şudur: İlk gün ana işlem gerçekleştirilir ve mühürlerin kırıldığına dair kanıtlar video ile paylaşılır. Ardından 7 gün sürecek olan sabitleme okumaları başlar. Genelde 3. günden itibaren ilk etkiler dilde yumuşama olarak belirir.";
    }

    const CARE_TEMPLATES = {
      fitne_sogutma: {
        intro: (ctx) => `${ctx.isim} ${ctx.hitap}, paylaştığınız manevi izler üzerinden yaptığım derin tecelli neticesinde, hayatınızda bir anda beliren o soğukluğun asıl kaynağına ulaştım. İsimleriniz (Danışan: ${ctx.isim} - Anne: ${ctx.anne}, Muhatap: ${ctx.karsi} - Anne: ${ctx.kAnne}) üzerinden yapılan tarama, düğümün yerini saptamıştır.`,
        daily: (ctx) => `Yapılan bakımda üzerinizde **${ctx.spellName}** tespit edildi. Bu mühür, iki kişi arasına üçüncü şahısların zehirli sözlerini duvar örer, şüpheyi besler ve sebepsiz yere birbirinize tahammül edememe hali oluşturur.`,
        tie: (ctx) => "Konuşma akışınızda görülen o ani kopukluklar ve muhatabın dündeki muhabbetini bugün unutmuş olması, bu fitne düğümünün en belirgin izidir. Mesele sadece fikir ayrılığı değil, araya sızan negatif frekanstır.",
        promise: (ctx) => `Allah’ın izniyle bu **${ctx.spellName} kökten ve kalıcı olarak hükümsüz kılınacaktır.** Mühürler parçalandığında aradaki o yapay duvar yıkılacak, iletişim yeniden doğal ve sıcak bir akışa kavuşacaktır.`,
        process: () => buildProcessBlock(),
        past: () => "Daha önce benzer fitne mühürleri ile dağılan yuvalarda, bu kilit söküldüğü an kalplerdeki muhabbetin nasıl yeniden alevlendiğini bizzat müşahede ettik. Doğru teşhis, sonucun yarısıdır.",
        close: () => "Şimdi karar verme vaktidir. Bu karanlığı söküp atmak ve bağları yeniden sağlamlaştırmak için niyetinizi net bir şekilde bildirmeniz yeterlidir. Selametle."
      },
      aile_engeli: {
        intro: (ctx) => `${ctx.isim} ${ctx.hitap}, isimleriniz üzerinden gerçekleştirdiğim manevi tarama sonucunda yuva yolunuza örülen o görünmez duvarın asıl sebebine ulaştım. (Danışan: ${ctx.isim} - Anne: ${ctx.anne}, Muhatap: ${ctx.karsi} - Anne: ${ctx.kAnne}).`,
        daily: (ctx) => `Bakım neticesinde üzerinizde **${ctx.spellName}** saptanmıştır. Bu işlem, aile büyüklerinin iradesini mühürleyerek sebepsiz direnç oluşturur ve iki kişinin hayırlı birleşimine sürekli engel çıkarır.`,
        tie: (ctx) => "Ev içinde konu her açıldığında yükselen o gerginlik ve muhatabın ailesi ile sizin aranızda kalıp net bir duruş sergileyememesi, bu direnç mühürlerinin kalbe vurduğu pranganın sonucudur.",
        promise: (ctx) => `Allah’ın izniyle bu **${ctx.spellName} tertibi tamamen bozulacaktır.** Aile tarafındaki o sertlik yerini yumuşamaya bırakacak, kapatılan kapılar hayırlısıyla sonuna kadar aralanacaktır.`,
        process: () => buildProcessBlock(),
        past: () => "Yıllarca karşı çıkılan evlilik süreçlerinde, bu manevi kilit çözüldüğünde ailelerin nasıl bir anda onay verdiğini ve yolun temizlendiğini defalarca gördük.",
        close: () => "Bu engeli ortadan kaldırmak ve yuvanızı kurmak için kararlı bir niyetle yola çıkmaya hazırım. Yolun açık olması için niyetinizi bildiriniz. Selametle."
      },
      rizik_kapama: {
        intro: (ctx) => `${ctx.isim} ${ctx.hitap}, rızık kapılarınızdaki o daralmanın ve bereketin tutmamasının manevi sebepleri bizzat müşahede edilmiştir. (Danışan: ${ctx.isim} - Anne: ${ctx.anne}).`,
        daily: (ctx) => `Yapılan incelemede üzerinizde **${ctx.spellName}** olduğu netleşmiştir. Bu şer işlem, kazancın elde tutulmasını engeller, kısmeti kapatır ve borç döngüsünü bitmek bilmeyen bir yük haline getirir.`,
        tie: (ctx) => "Paranın bir anda uçup gitmesi, beklenen kapıların son anda yüzünüze kapanması ve ne kadar çalışırsanız çalışın sonucun değişmemesi, bu bereket düğümünün klasik yansımasıdır.",
        promise: (ctx) => `Allah’ın izniyle bu **${ctx.spellName} mühürleri paramparça edilecektir.** Rızık kanallarınız yeniden açılacak, maddi ferahlık ve bereket hayatınıza tekrar akmaya başlayacaktır.`,
        process: () => buildProcessBlock(),
        past: () => "İflasın eşiğinden dönen ve iş kapısı tamamen mühürlenen danışanlarımda, bu kilit açıldığı an kısmetin nasıl sağanak gibi yağdığını bizzat gördük.",
        close: () => "Kaderinizdeki bu düğümü çözmek ve refaha kavuşmak için niyetinizi sarsılmaz bir kararlılıkla bildirmeniz kafidir. Selametle."
      },
      kismet_kapama: {
        intro: (ctx) => `${ctx.isim} ${ctx.hitap}, hayırlı bir yuva kurma yolundaki o anlamsız gecikmelerin ve yarım kalan başlangıçların kökenine ulaştım. (Danışan: ${ctx.isim} - Anne: ${ctx.anne}).`,
        daily: (ctx) => `Manevi tarama neticesinde üzerinizde **${ctx.spellName}** tespit edilmiştir. Bu mühür, tam ciddi bir yola girilecekken karşı tarafın kaçmasına veya her şeyin sebepsizce bozulmasına neden olur.`,
        tie: (ctx) => "Kısmetinizin sürekli engellenmesi, adayların bir anda fikir değiştirmesi veya sizin içinizin sebepsizce daralıp her şeyden vazgeçme isteğiniz, bu yol bağlama işleminin eseridir.",
        promise: (ctx) => `Allah’ın izniyle bu **${ctx.spellName} hükmü ebediyen son bulacaktır.** Kısmet yolunuzdaki tüm engeller kalkacak, beklediğiniz o hayırlı kapı en güzel şekilde açılacaktır.`,
        process: () => buildProcessBlock(),
        past: () => "Yıllarca evlilik kapısı mühürlü kalan kişilerin, bu düğüm çözüldükten sonra ne kadar kısa sürede hayırlı bir yuva kurduklarına şahit olduk.",
        close: () => "Bahtınızın açılması ve bu manevi baskıdan kurtulmanız için niyetinizi net bir şekilde ifade etmeniz yeterlidir. Selametle."
      },
      karar_zayif: {
        intro: (ctx) => `${ctx.isim} ${ctx.hitap}, muhatabınızdaki o anlaşılmaz gelgitlerin ve kararsızlıkların asıl kaynağı manevi boyutta saptanmıştır. (Danışan: ${ctx.isim} - Anne: ${ctx.anne}, Muhatap: ${ctx.karsi} - Anne: ${ctx.kAnne}).`,
        daily: (ctx) => `İnceleme sonucunda üzerinizde **${ctx.spellName}** saptanmıştır. Bu mühür, kişinin iradesini zayıflatır, net karar vermesini engeller ve sürekli bir gün iyi bir gün kötü bir hal içinde bırakır.`,
        tie: (ctx) => "Bir an çok yakın olup ertesi gün hiçbir şey yokmuş gibi davranması, dününe sahip çıkamaması, bu niyet dağıtma mühürlerinin zihinde oluşturduğu o bulanık perdenin sonucudur.",
        promise: (ctx) => `Allah’ın izniyle bu **${ctx.spellName} düğümü sökülüp atılacaktır.** Muhatabın zihni ve kalbi durulacak, kararları sarsılmaz bir netliğe ve kararlılığa kavuşacaktır.`,
        process: () => buildProcessBlock(),
        past: () => "Yönü sürekli değişen ve kararsızlığı ile hayatı zindan eden vakalarda, bu kilit çözüldüğünde sadakatin ve netliğin nasıl geri geldiğini defalarca gördük.",
        close: () => "Bu belirsizliği bitirmek ve bağlarınızı sabitlemek için niyetinizi kararlı bir sesle bildirmeniz kafidir. Selametle."
      },
      sogutma_ayirma: {
        intro: (ctx) => `${ctx.isim} ${ctx.hitap}, aradaki o ani kopuşun ve kalpteki o dehşetli soğumanın manevi sebepleri gün yüzüne çıkarılmıştır. (Danışan: ${ctx.isim} - Anne: ${ctx.anne}, Muhatap: ${ctx.karsi} - Anne: ${ctx.kAnne}).`,
        daily: (ctx) => `Maneviyat taramasında üzerinizde **${ctx.spellName}** saptanmıştır. Bu zifiri mühür, muhabbeti nefrete dönüştürmek, gözü görmez, kalbi hissetmez kılmak için zifiri niyetlerle hazırlanmıştır.`,
        tie: (ctx) => "Size bakarken o eski sevgiyi görememeniz, muhatabın 'içimden gelmiyor' demesi ve sizden kaçması, bu ayırma mühürlerinin kalbe ördüğü buzdan duvarın işaretidir.",
        promise: (ctx) => `Allah’ın izniyle bu **${ctx.spellName} ebediyen parçalanacaktır.** Kalplerdeki o yapay soğuma kalkacak, yerini eskisinden daha güçlü bir sevgi ve bağlılığa bırakacaktır.`,
        process: () => buildProcessBlock(),
        past: () => "Boşanma aşamasına gelen ve birbirinden nefret eder hale getirilen çiftlerin, bu mühür kırıldıktan sonra nasıl bir aşkla birleştiğine defalarca şahit olduk.",
        close: () => "Bu buzdan duvarı yıkmak ve kalpleri yeniden birleştirmek için niyetinizi kesin bir dille belirtmeniz kafidir. Selametle."
      }
    };

    function buildLifeReflection(ctx, analysis, tplKey){
      const t = analysis.themes || [];
      const themeLine = t.length ? t.join(", ") : "genel tıkanıklık";
      const base = [];
      base.push("Sizde görünen tabloda en dikkat çeken şey, aynı döngünün tekrar etmesidir: bir noktada umut doğuyor, ardından sebepsiz bir ağırlık çöküyor ve süreç yeniden duruyor. Bu, dış müdahale düğümlerinin klasik izidir. İnsan “ben mi yanlış yapıyorum” diye kendini sorgular ama mesele sizin hatanız değildir.");
      base.push(`Konuşma akışında beliren ${themeLine} tarafı, yaşadığınız yükü artırır. Bekleme uzadıkça insanın içi daralır; bu da bazen acele karar almaya iter. Burada önemli olan, düğümü doğru yerden çözmek ve süreci disiplinli götürmektir.`);
      base.push("Bu çalışmanın mantığı şudur: Önce kilit çözülür, sonra yön sabitlenir. Kilit çözülmeden sabitleme olmaz; sabitleme olmadan da sonuç kalıcı olmaz. Bu yüzden adım adım yürümek şarttır.");
      
      if(tplKey === "rizik_kapama" || tplKey === "yol_baglama"){
        base.push("Maddi tarafta düğüm çözüldüğünde ilk işaret genelde küçük ama net olur: bir haber, bir görüşme, bir fırsat, bir ödeme. Ardından süreç akmaya başlar.");
      } else if(tplKey === "aile_engeli"){
        base.push("Aile düğümlerinde ilk işaret genelde dil değişimidir: ‘olmaz’ sertliği azalır, konuşma tonu yumuşar, sonra karar kapısı aralanır.");
      } else {
        base.push("İlişki düğümlerinde ilk işaret genelde yakınlaşma isteğidir: iletişim uzar, kaçınma düşer, sonra netlik gelir. Netlik geldikçe bağ sağlamlaşır.");
      }
      return base.join(" ");
    }

    /* ============================================================
        V10 ENTERPRISE - BUILD CARE TEXT (MAIN)
    ============================================================ */
    function buildCareText(ctx){
      const analysis = analyzeLog(ctx.log);
      const chosen = decideSpell(ctx.talep, analysis);
      const tplKey = Object.keys(SPELL_POOL).find(k => SPELL_POOL[k].name === chosen.name) || "fitne_sogutma";
      const tpl = CARE_TEMPLATES[tplKey] || CARE_TEMPLATES.fitne_sogutma;

      ctx.spellName = chosen.name;

      const blocks = [
        tpl.intro(ctx),
        tpl.daily(ctx),
        tpl.tie(ctx),
        tpl.promise(ctx),
        tpl.past(ctx),
        buildNoOtherHocaNote(),
        tpl.close(ctx)
      ];

      if(ctx.mode === "enterprise_max"){
        blocks.splice(3, 0, buildLifeReflection(ctx, analysis, tplKey));
      }
      
      const merged = blocks.join("\n\n");
      const enforced = enforceMinChars(merged, ctx.mode);
      
      return postProcessCareText(enforced);
    }

    function collectContext(){
      const isim = toTitleTr($("isim").value);
      const anne = toTitleTr($("anne").value);
      const karsi = toTitleTr($("karsi").value);
      const kAnne = toTitleTr($("kAnne").value);
      return {
        isim: isim || "Danışan",
        anne: anne || "-",
        karsi: karsi || "-",
        kAnne: kAnne || "-",
        hitap: getHitap(),
        talep: $("talep").value || "auto",
        mode: $("mode").value || "enterprise_ultra",
        log: safeTrim($("log").value)
      };
    }

    function validate(ctx){
      if(!safeTrim(ctx.isim) || ctx.isim === "Danışan"){ alert("Danışan adını girin."); return false; }
      if(!safeTrim(ctx.anne) || ctx.anne === "-"){ alert("Danışan anne adını girin."); return false; }
      if(!safeTrim(ctx.log)){ alert("WhatsApp konuşmasını / belirtileri yapıştırın."); return false; }
      if(ctx.karsi !== "-" && ctx.karsi.length > 0 && (ctx.kAnne === "-" || !ctx.kAnne)){
        alert("Muhatap adı girildiyse, muhatap anne adını da girin.");
        return false;
      }
      return true;
    }

    function setOverlay(show, msg){
      const ov = $("overlay");
      const m = $("overlayMsg");
      if(msg) m.innerText = msg;
      ov.style.display = show ? "flex" : "none";
    }

    function generate(){
      const ctx = collectContext();
      if(!validate(ctx)) return;

      setOverlay(true, "Konuşma akışı okunuyor, konu sınıflandırılıyor...");
      $("btnGenerate").disabled = true;
      $("btnGenerate").style.opacity = "0.75";

      setTimeout(() => {
        setOverlay(true, "Büyü türü netleştiriliyor, şablon seçiliyor...");
        setTimeout(() => {
          setOverlay(true, "Kişiye özel Enterprise metin hazırlanıyor...");
          setTimeout(() => {
            const text = buildCareText(ctx);
            $("output").innerText = text;
            $("resultWrap").classList.remove("hidden");
            setOverlay(false);
            $("btnGenerate").disabled = false;
            $("btnGenerate").style.opacity = "1";
            $("resultWrap").scrollIntoView({ behavior: "smooth", block: "start" });
          }, 650);
        }, 650);
      }, 650);
    }

    /* ============================================================
        V10 ENTERPRISE - POST-PROCESS ENGINE
    ============================================================ */
    function _simJaccard(a, b){
      if(!a || !b) return 0;
      const wa = new Set(a.toLowerCase().split(/\s+/));
      const wb = new Set(b.toLowerCase().split(/\s+/));
      let inter = 0;
      wa.forEach(w=>{ if(wb.has(w)) inter++; });
      const union = wa.size + wb.size - inter;
      return union ? inter/union : 0;
    }

    function _dedupeSentences(text, threshold=0.60){
      const sents = text.split(/(?<=[.!?])\s+/);
      const out = [];
      for(let i=0;i<sents.length;i++){
        const cur = sents[i].trim();
        if(!cur) continue;
        let dup = false;
        // Check long range (last 20 sentences)
        for(let j=Math.max(0,out.length-20); j<out.length; j++){
          if(_simJaccard(cur, out[j]) >= threshold){ dup = true; break; }
        }
        if(!dup) out.push(cur);
      }
      return out.join(" ");
    }

    function _normalizeBlocks(text){
      let parts = text.split(/\n{2,}/);
      const cleaned = [];
      for(let i=0;i<parts.length;i++){
        const p = parts[i].trim();
        if(!p) continue;
        let dup = false;
        for(let j=0; j<cleaned.length; j++){
           if(_simJaccard(p, cleaned[j]) > 0.50){ dup = true; break; }
        }
        if(!dup) cleaned.push(p);
      }
      return cleaned.join("\n\n");
    }

    function postProcessCareText(text){
      let t = text;
      t = _normalizeBlocks(t);
      t = _dedupeSentences(t, 0.60);
      t = t.replace(/\n{3,}/g, "\n\n").trim();
      return t;
    }
  </script>

</body>
</html>
