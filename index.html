<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Bakım Oluşturma Sistemi</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700;800;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root {
      --bg-deep: #020617;
      --bg-card: #0b1120;
      --indigo-glow: #6366f1;
      --indigo-soft: rgba(99, 102, 241, 0.1);
      --border-color: #1e293b;
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --danger: #ef4444;
    }

    body {
      background-color: var(--bg-deep);
      color: var(--text-main);
      font-family: 'Montserrat', sans-serif;
      overflow-x: hidden;
    }

    .glass-panel {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      box-shadow: 0 0 50px rgba(0, 0, 0, 0.7);
    }

    .terminal-font { font-family: 'JetBrains Mono', monospace; }

    .apex-input {
      background: rgba(2, 6, 23, 0.9);
      border: 1px solid var(--border-color);
      color: var(--text-main);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .apex-input:focus {
      border-color: var(--indigo-glow);
      box-shadow: 0 0 25px var(--indigo-soft);
      outline: none;
    }

    .apex-btn {
      background: linear-gradient(135deg, #4338ca 0%, #6366f1 100%);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .apex-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 30px rgba(99, 102, 241, 0.4);
    }

    .log-console {
      background: #000;
      border: 1px solid #1e293b;
      height: 100px;
      overflow-y: auto;
      padding: 12px;
      font-size: 11px;
      color: #6366f1;
      line-height: 1.5;
    }

    .output-container {
      background: #020617;
      border-left: 4px solid var(--indigo-glow);
    }

    .status-box {
      background: #111827;
      border: 1px solid var(--indigo-glow);
      padding: 1rem;
      border-radius: 1rem;
      margin-top: 1rem;
      display: none;
    }

    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
  </style>
</head>
<body class="min-h-screen py-12 px-4">

  <div class="max-w-4xl mx-auto space-y-10">
    
    <header class="text-center space-y-4">
      <h1 class="text-4xl font-black uppercase tracking-tighter text-indigo-400 italic">
        Bakım Oluşturma Sistemi
      </h1>
      <div class="w-20 h-1 bg-indigo-500 mx-auto rounded-full opacity-50"></div>
    </header>

    <div class="glass-panel rounded-[2rem] p-8 md:p-12 relative overflow-hidden">
      
      <div class="space-y-10">
        
        <!-- Kimlik Alanları -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <section class="space-y-6">
            <h3 class="text-[10px] font-black text-indigo-400 uppercase tracking-widest">Danışan Bilgisi</h3>
            <div class="grid grid-cols-1 gap-4">
              <input id="isim" class="apex-input w-full p-5 rounded-xl text-sm font-bold uppercase" placeholder="İsim">
              <input id="anne" class="apex-input w-full p-5 rounded-xl text-sm font-bold uppercase" placeholder="Anne Adı">
            </div>
            
            <div class="space-y-4">
              <!-- Cinsiyet Seçimi -->
              <div class="flex p-1 bg-slate-950 rounded-xl border border-border-color">
                <button onclick="setHitap('Hanım')" id="btnHanım" class="hitap-btn flex-1 py-3 rounded-lg text-[10px] font-black transition-all bg-indigo-600 text-white">KADIN (HANIM)</button>
                <button onclick="setHitap('Bey')" id="btnBey" class="hitap-btn flex-1 py-3 rounded-lg text-[10px] font-black transition-all text-slate-500">ERKEK (BEY)</button>
              </div>

              <!-- WhatsApp Bölümü (Kadın/Erkek Altına Taşındı ve Büyütüldü) -->
              <div class="space-y-2">
                <label class="text-[10px] font-black text-indigo-400 uppercase tracking-widest ml-1">WhatsApp Numara Ekleme</label>
                <input id="tel" class="apex-input w-full p-6 rounded-xl text-center font-bold text-lg tracking-[0.2em] text-indigo-200" placeholder="5xx xxx xx xx">
              </div>
            </div>
          </section>

          <section class="space-y-6">
            <h3 class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Karşı Taraf</h3>
            <div class="grid grid-cols-1 gap-4">
              <input id="karsi" class="apex-input w-full p-5 rounded-xl text-sm font-bold uppercase" placeholder="Muhatap İsmi">
              <input id="kAnne" class="apex-input w-full p-5 rounded-xl text-sm font-bold uppercase" placeholder="Muhatap Anne Adı">
            </div>
            <div class="p-6 bg-slate-950/30 border border-dashed border-slate-800 rounded-xl h-[120px] flex items-center justify-center text-center">
              <p class="text-[10px] text-slate-600 italic leading-relaxed">Muhatap bilgisi yoksa <br>bu alanları boş bırakabilirsiniz.</p>
            </div>
          </section>
        </div>

        <!-- Süreç Alanı -->
        <section class="space-y-4">
          <div class="flex justify-between items-center">
            <h3 class="text-[10px] font-black text-indigo-400 uppercase tracking-widest">Durum ve Belirtiler</h3>
            <span id="charCount" class="text-[9px] terminal-font text-slate-600">0 CHAR</span>
          </div>
          <textarea id="log" rows="6" class="apex-input w-full p-6 rounded-2xl text-sm font-semibold leading-relaxed" 
            placeholder="Analiz edilmesi gereken olayları veya mesajları buraya aktarın..."></textarea>
        </section>

        <!-- Analiz Butonu -->
        <section class="space-y-6">
          <div class="log-console terminal-font rounded-lg" id="systemLog">
            > Ready for maintenance analysis...
          </div>
          
          <div class="flex flex-col md:flex-row gap-4">
            <button onclick="runAdvancedAnalysis()" id="mainActionButton" class="apex-btn flex-1 py-6 rounded-2xl font-black text-xs tracking-[0.3em] flex items-center justify-center gap-3">
              <span>BAKIM OLUŞTUR VE ANALİZ ET</span>
            </button>
            <button onclick="shareWhatsApp()" class="px-8 rounded-2xl bg-emerald-600 hover:bg-emerald-500 text-white transition-all shadow-lg flex items-center justify-center">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
            </button>
          </div>
          <div id="statusMessage" class="status-box text-xs font-bold text-center"></div>
        </section>

      </div>
    </div>

    <!-- Sonuç Bölümü -->
    <section id="resultZone" class="hidden opacity-0 transform translate-y-10 transition-all duration-1000">
      <div class="glass-panel rounded-[2rem] p-10 md:p-14 overflow-hidden relative">
        <div class="flex flex-col md:flex-row justify-between items-center gap-10 mb-12">
          <div class="space-y-3">
            <div class="text-indigo-400 text-[10px] font-black uppercase tracking-[0.3em]">Manevi Teşhis</div>
            <h2 class="text-3xl font-black italic">Bakım Kararnamesi</h2>
          </div>
          <div class="flex gap-4">
            <button onclick="speakVerdict()" id="btnSpeak" class="px-6 py-4 bg-indigo-900/40 border border-indigo-500/30 text-indigo-300 rounded-xl font-black text-[10px] uppercase hover:bg-indigo-500 hover:text-white transition-all">SESLİ DİNLE</button>
            <button onclick="copyVerdict()" class="px-10 py-4 bg-white text-black rounded-xl font-black text-[10px] uppercase hover:bg-indigo-500 hover:text-white transition-all">KOPYALA</button>
          </div>
        </div>
        <div id="verdictOutput" class="output-container p-8 md:p-12 text-slate-300 text-lg md:text-xl leading-[2.4] font-medium italic border-indigo-500/50"></div>
      </div>
    </section>

  </div>

  <div id="globalOverlay" class="fixed inset-0 bg-slate-950/98 z-[100] hidden flex-col items-center justify-center text-center p-10">
    <div class="w-32 h-32 mb-10 border-4 border-indigo-500/20 border-t-indigo-500 rounded-full animate-spin"></div>
    <div id="loaderStatus" class="text-2xl font-black italic text-indigo-100 uppercase tracking-tighter mb-2">Bakım Yapılıyor...</div>
    <div class="text-indigo-500/60 terminal-font text-[10px] uppercase tracking-widest">Neural Link Active</div>
  </div>

  <script>
    const apiKey = ""; // Bu alan platform tarafından otomatik doldurulur.
    const state = { hitap: "Hanım" };

    function setHitap(h) {
      state.hitap = h;
      document.querySelectorAll('.hitap-btn').forEach(b => {
        b.classList.remove('bg-indigo-600', 'text-white');
        b.classList.add('text-slate-500');
      });
      event.target.classList.add('bg-indigo-600', 'text-white');
      event.target.classList.remove('text-slate-500');
    }

    function writeLog(msg) {
      const console = document.getElementById('systemLog');
      if (console) {
        console.innerHTML += `<br>> ${msg}`;
        console.scrollTop = console.scrollHeight;
      }
    }

    function showStatus(msg, isError = false) {
      const box = document.getElementById('statusMessage');
      if (!box) return;
      box.style.display = 'block';
      box.style.color = isError ? '#ef4444' : '#6366f1';
      box.style.borderColor = isError ? '#ef4444' : '#6366f1';
      box.innerText = msg;
      setTimeout(() => { box.style.display = 'none'; }, 5000);
    }

    async function callGemini(userPrompt, systemPrompt = "", isTTS = false) {
      let retries = 0;
      const maxRetries = 5;
      
      const payload = isTTS 
        ? { 
            contents: [{ parts: [{ text: userPrompt }] }], 
            generationConfig: { 
              responseModalities: ["AUDIO"], 
              speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } } 
            } 
          }
        : { 
            contents: [{ parts: [{ text: userPrompt }] }],
            systemInstruction: systemPrompt ? { parts: [{ text: systemPrompt }] } : undefined
          };

      const modelName = isTTS ? 'gemini-2.5-flash-preview-tts' : 'gemini-2.5-flash-preview-09-2025';
      const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;

      while (retries < maxRetries) {
        try {
          const response = await fetch(url, { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify(payload) 
          });
          
          if (response.ok) {
            return await response.json();
          }
          
          // Retryable errors
          if (response.status === 429 || response.status >= 500) {
            retries++;
          } else {
            const errData = await response.json();
            throw new Error(errData.error?.message || "İstek başarısız.");
          }
        } catch (e) {
          if (retries === maxRetries - 1) throw e;
          retries++;
        }
        await new Promise(r => setTimeout(r, Math.pow(2, retries) * 1000));
      }
      throw new Error("Bağlantı hatası.");
    }

    async function runAdvancedAnalysis() {
      const isim = document.getElementById('isim').value;
      const anne = document.getElementById('anne').value;
      const karsi = document.getElementById('karsi').value;
      const kAnne = document.getElementById('kAnne').value;
      const log = document.getElementById('log').value;
      const btn = document.getElementById('mainActionButton');

      if(!isim || !anne || !log) { 
        showStatus("Lütfen gerekli alanları doldurun.", true);
        return; 
      }

      document.getElementById('globalOverlay').classList.remove('hidden');
      document.getElementById('globalOverlay').classList.add('flex');
      btn.disabled = true;
      writeLog("Manevi tarama başlatıldı...");

      const systemPrompt = `Sen profesyonel bir manevi bakım uzmanısın. 
      KURALLAR:
      1. Mutlaka spesifik bir büyü ismi tespit et.
      2. Bu büyünün kesinlikle bozulacağını vurgula. 
      3. 7 günlük bir süreçten bahset.
      4. Teknik terim kullanma.`;

      const userPrompt = `Danışan: ${isim}, Anne: ${anne}. Muhatap: ${karsi}, Muhatap Anne: ${kAnne}. Durum: ${log}. Hitap: ${state.hitap}.`;

      try {
        const result = await callGemini(userPrompt, systemPrompt);
        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
        
        if (text) {
          document.getElementById('verdictOutput').innerText = text;
          const zone = document.getElementById('resultZone');
          zone.classList.remove('hidden');
          setTimeout(() => {
            zone.classList.remove('opacity-0', 'translate-y-10');
            zone.scrollIntoView({ behavior: 'smooth' });
          }, 50);
          writeLog("Bakım başarıyla tamamlandı.");
        }
      } catch (e) {
        showStatus("Bağlantı hatası. Lütfen bir an bekleyip tekrar deneyin.", true);
        writeLog("Hata: " + e.message);
      } finally {
        document.getElementById('globalOverlay').classList.add('hidden');
        btn.disabled = false;
      }
    }

    async function speakVerdict() {
      const text = document.getElementById('verdictOutput').innerText;
      if(!text) return;
      const btn = document.getElementById('btnSpeak');
      btn.innerText = "HAZIRLANIYOR...";
      btn.disabled = true;
      
      try {
        const result = await callGemini(`Mistik bir sesle oku: ${text.substring(0, 1000)}`, "", true);
        const pcmData = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
        if (pcmData) {
          const audioBlob = pcmToWav(pcmData, 24000);
          new Audio(URL.createObjectURL(audioBlob)).play();
        }
      } catch (e) {
        showStatus("Ses oluşturulamadı.", true);
      } finally { 
        btn.innerText = "SESLİ DİNLE"; 
        btn.disabled = false;
      }
    }

    function pcmToWav(base64, sampleRate) {
      const binaryString = atob(base64), len = binaryString.length, bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);
      const buffer = new ArrayBuffer(44 + bytes.length), view = new DataView(buffer);
      const writeStr = (o, s) => { for (let i = 0; i < s.length; i++) view.setUint8(o + i, s.charCodeAt(i)); };
      writeStr(0, 'RIFF'); view.setUint32(4, 36 + bytes.length, true); writeStr(8, 'WAVE'); writeStr(12, 'fmt ');
      view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true);
      view.setUint32(24, sampleRate, true); view.setUint32(28, sampleRate * 2, true);
      view.setUint16(32, 2, true); view.setUint16(34, 16, true); writeStr(36, 'data'); view.setUint32(40, bytes.length, true);
      new Uint8Array(buffer, 44).set(bytes);
      return new Blob([buffer], { type: 'audio/wav' });
    }

    function copyVerdict() { 
      const text = document.getElementById('verdictOutput').innerText;
      if (!text) return;
      navigator.clipboard.writeText(text); 
      showStatus("Kopyalandı."); 
    }

    function shareWhatsApp() {
      const t = document.getElementById('verdictOutput').innerText;
      let tel = document.getElementById('tel').value.replace(/\D/g, "");
      if (tel && !tel.startsWith("90")) tel = "90" + tel;
      window.open(`https://wa.me/${tel}?text=${encodeURIComponent(t)}`, "_blank");
    }

    document.getElementById('log').addEventListener('input', (e) => { 
      document.getElementById('charCount').innerText = `${e.target.value.length} CHAR`; 
    });
  </script>
</body>
</html>
