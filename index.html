<!--
================================================================================
V9.2 ENTERPRISE (700+ satır / yorumlu / bilerek uzun)
- Tek dosya: HTML + CSS + JS
- Mobil uyumlu (responsive + safe viewport)
- WhatsApp’a numarayla gönderim aktif
- Konuşmadan büyü türü otomatik seçilir (ağırlıklı pattern skoru)
- İlişki vakalarında 2. şahıs zorunlu (geri_getirme / baglama / aile_engeli)
- Çıktı teknik/rapor dili içermez (danışana gidecek WhatsApp dili)
- ULTRA UZUN MOD: minimum 3000 karakter kilidi (kısa metin çıkamaz)

NOT:
- Satır sayısı bilerek yüksek tutuldu: açıklamalar + ayrık bloklar + ayrı şablonlar.
- “Birebir ilk HTML” hissi korunacak şekilde aynı yapı ve stiller korunarak genişletildi.
================================================================================
-->
<!DOCTYPE html>
<html lang="tr">
<head>
  <!-- =======================
       META / VIEWPORT
  ======================== -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <title>Genel Manevi Bakım Analiz Sistemi – V9.2 Enterprise</title>

  <!-- =======================
       FONT / TAILWIND
  ======================== -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- =======================
       STYLE: “İLK HTML” RUHU
       - Arka plan, kart, input, label, radio butonları korunur
       - Enterprise sürümde ekstra yardımcı sınıflar + loading + erişilebilirlik eklendi
  ======================== -->
  <style>
    /* -----------------------
       Base
    ----------------------- */
    body {
      background: #0f172a;
      color: #f1f5f9;
      font-family: 'Montserrat', sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    /* -----------------------
       Card Container (İlk HTML)
    ----------------------- */
    .card {
      background: #111827;
      border: 1px solid #1f2937;
    }

    /* -----------------------
       Inputs (İlk HTML)
    ----------------------- */
    .input-field {
      background: #1f2937;
      border: 1px solid #374151;
      color: white;
      transition: 0.2s;
    }
    .input-field:focus {
      border-color: #6366f1;
      outline: none;
    }

    /* -----------------------
       Gender Toggle (İlk HTML)
    ----------------------- */
    .gender-btn {
      flex: 1;
      padding: 12px;
      border: 1px solid #374151;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: 800;
      transition: 0.3s;
      user-select: none;
    }
    input[type="radio"]:checked + .gender-btn {
      background: #4f46e5;
      border-color: #818cf8;
      color: white;
    }

    /* -----------------------
       Labels (İlk HTML)
    ----------------------- */
    label {
      font-weight: 700;
      font-size: 0.65rem;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      display: block;
      margin-bottom: 5px;
    }

    /* -----------------------
       Enterprise: Hint text
    ----------------------- */
    .hint {
      font-size: 0.78rem;
      color: #94a3b8;
      line-height: 1.55;
    }

    /* -----------------------
       Enterprise: Badges
    ----------------------- */
    .badge {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 800;
      letter-spacing: 0.02em;
      border: 1px solid transparent;
    }
    .badge-blue {
      background: rgba(99,102,241,.14);
      color: #a5b4fc;
      border-color: rgba(99,102,241,.35);
    }
    .badge-green {
      background: rgba(34,197,94,.12);
      color: #bbf7d0;
      border-color: rgba(34,197,94,.35);
    }
    .badge-red {
      background: rgba(239,68,68,.12);
      color: #fecaca;
      border-color: rgba(239,68,68,.35);
    }

    /* -----------------------
       Enterprise: Required highlight
       - İlişki vakalarında 2. kişi alanlarını belirginleştirir
    ----------------------- */
    .required-ring {
      border-color: rgba(239,68,68,.75) !important;
      box-shadow: 0 0 0 3px rgba(239,68,68,.18);
    }

    /* -----------------------
       Enterprise: Loading box (gerçek “analiz ediliyor” hissi)
    ----------------------- */
    .loading-wrap {
      margin-top: 16px;
      padding: 16px;
      background: #0b1220;
      border: 1px solid #1f2937;
      border-radius: 16px;
    }
    .loading-title {
      font-weight: 900;
      color: #c7d2fe;
      text-align: center;
      margin-bottom: 10px;
      letter-spacing: .02em;
    }
    .loading-step {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(15,23,42,.6);
      border: 1px solid rgba(148,163,184,.15);
      margin-bottom: 10px;
    }
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: rgba(148,163,184,.35);
    }
    .dot.active {
      background: #818cf8;
      box-shadow: 0 0 0 6px rgba(129,140,248,.15);
    }
    .step-text {
      font-size: .9rem;
      color: #cbd5e1;
      font-weight: 600;
    }

    /* -----------------------
       Enterprise: Result area formatting
    ----------------------- */
    #analizMetni {
      white-space: pre-wrap;          /* WhatsApp metni gibi */
      word-break: break-word;
    }

    /* -----------------------
       Enterprise: Copy button
    ----------------------- */
    .copy-btn {
      width: 100%;
      margin-top: 10px;
      padding: 16px;
      border-radius: 16px;
      font-weight: 900;
      text-transform: uppercase;
      background: #334155;
      color: #e2e8f0;
      transition: .2s;
    }
    .copy-btn:hover { background: #475569; }

    /* -----------------------
       Small accessibility helpers
    ----------------------- */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  </style>
</head>

<body class="min-h-screen flex items-center justify-center p-4 bg-slate-950">

  <!-- =======================
       MAIN CARD
  ======================== -->
  <div class="w-full max-w-2xl card rounded-3xl p-6 md:p-10 relative">
    <div class="absolute top-0 left-0 w-full h-1.5 bg-indigo-600"></div>

    <!-- Header -->
    <div class="flex items-center justify-between gap-3 mb-2">
      <h1 class="text-xl font-black text-white uppercase italic">Manevi Analiz Sistemi</h1>
      <span class="badge badge-blue">V9.2 ENTERPRISE</span>
    </div>

    <p class="hint mb-6">
      WhatsApp konuşmalarını yapıştırın. Sistem konuşmanın içinden asıl düğümü yakalar, büyü türünü belirler ve danışana gidecek şekilde
      ultra uzun bakım metnini hazırlar.
    </p>

    <!-- =======================
         FORM
    ======================== -->
    <div class="space-y-6">

      <!-- Hitap -->
      <div class="flex gap-3 mb-2">
        <label class="flex-1 cursor-pointer">
          <input type="radio" name="hitap" value="Hanım" class="sr-only" checked>
          <div class="gender-btn">KADIN (HANIM)</div>
        </label>
        <label class="flex-1 cursor-pointer">
          <input type="radio" name="hitap" value="Bey" class="sr-only">
          <div class="gender-btn">ERKEK (BEY)</div>
        </label>
      </div>

      <!-- Danışan -->
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label>Danışan Adı</label>
          <input id="isim" type="text" class="w-full p-4 rounded-xl input-field uppercase" placeholder="Ad">
        </div>
        <div>
          <label>Anne Adı</label>
          <input id="anneAdi" type="text" class="w-full p-4 rounded-xl input-field uppercase" placeholder="Anne Adı">
        </div>
      </div>

      <!-- Muhatap -->
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label>Muhatap Adı</label>
          <input id="ekIsim" type="text" class="w-full p-4 rounded-xl input-field uppercase" placeholder="Eş / Nişanlı / Sevgili">
        </div>
        <div>
          <label>Muhatap Anne</label>
          <input id="ekAnneAdi" type="text" class="w-full p-4 rounded-xl input-field uppercase" placeholder="Anne Adı">
        </div>
      </div>

      <!-- İşlem -->
      <div>
        <label>İstenen İşlem</label>
        <select id="islemTuru" class="w-full p-4 rounded-xl input-field font-bold text-indigo-300">
          <option value="kismet_acma">Kısmet Açma (Evlilik / Yuva)</option>
          <option value="geri_getirme">Geri Getirme (İlişki)</option>
          <option value="baglama">Bağlama (İlişki)</option>
          <option value="rizik_acma">Rızık / Bereket</option>
          <option value="aile_engeli">Aile Engeli (Evlilik / İlişki)</option>
          <option value="evrak_yol">Yol / Evrak / Vatandaşlık</option>
          <option value="genel">Genel Hayat (Karma)</option>
        </select>

        <div class="hint mt-2">
          <span class="badge badge-green">Bilgi</span>
          Geri getirme / bağlama / aile engeli seçiliyse muhatap adı ve muhatap anne adı zorunludur.
        </div>
      </div>

      <!-- WhatsApp log -->
      <div>
        <label>WhatsApp Konuşmaları / Belirtiler</label>
        <textarea id="hikayeLog" rows="7" placeholder="Gerçek konuşmaları buraya yapıştırın..." class="w-full p-4 rounded-xl input-field text-sm font-normal"></textarea>
        <div class="hint mt-2">Konuşma ne kadar gerçek ve detaylıysa metin o kadar kişiye özel çıkar.</div>
      </div>

      <!-- Tel -->
      <div class="p-4 bg-slate-900 rounded-2xl border border-green-500/20">
        <label class="text-green-400">Danışan No</label>
        <input id="telNo" type="tel" placeholder="5xx xxx xx xx" class="w-full p-4 rounded-xl input-field text-center font-black tracking-widest text-2xl bg-slate-950">
        <div class="hint mt-2 text-center">Numara girerseniz WhatsApp o numaraya açılır ve metin hazır gelir.</div>
      </div>

      <!-- Button -->
      <button onclick="analiziBaslatV92()" id="btnAnaliz" class="w-full py-5 bg-indigo-600 hover:bg-indigo-500 text-white font-black rounded-2xl transition uppercase text-sm">
        Bakım Metnini Oluştur
      </button>

      <!-- Loading -->
      <div id="loadingBox" class="loading-wrap hidden" aria-live="polite">
        <div class="loading-title">Analiz Yapılıyor</div>
        <div class="loading-step">
          <div id="dot1" class="dot"></div>
          <div class="step-text">Konuşmalar okunuyor, tekrar eden düğümler yakalanıyor…</div>
        </div>
        <div class="loading-step">
          <div id="dot2" class="dot"></div>
          <div class="step-text">Büyü türü ve ana mesele netleştiriliyor…</div>
        </div>
        <div class="loading-step">
          <div id="dot3" class="dot"></div>
          <div class="step-text">Ultra uzun bakım metni hazırlanıyor…</div>
        </div>
        <div class="hint text-center mt-3">Bu bekleme, “arka planda analiz” hissi için bilinçli olarak eklenmiştir.</div>
      </div>

      <!-- Result -->
      <div id="sonucAlani" class="mt-6 hidden border-t border-slate-800 pt-6">
        <div id="analizMetni" class="text-sm text-slate-300 leading-7 p-6 bg-slate-950 rounded-2xl border border-slate-700 font-medium shadow-inner"></div>
        <button class="copy-btn" onclick="kopyalaMetin()">Metni Kopyala</button>
        <button onclick="whatsappPaylasV92()" class="w-full mt-4 py-5 bg-green-600 hover:bg-green-500 text-white font-black rounded-2xl transition uppercase">
          WhatsApp İle Gönder
        </button>
        <div class="hint mt-3">
          Metin danışana gidecek şekilde hazırlanır; teknik/rapor dili yoktur.
        </div>
      </div>

    </div>
  </div>

  <!-- =======================
       V9.2 ENTERPRISE SCRIPT
       - PART-B: Dev şablonlar (her büyü ayrı)
       - PART-C: Analiz motoru + zorunlu uzunluk + WhatsApp send
  ======================== -->
  <script>
  /* ============================================================================
     V9.2 ENTERPRISE - GLOBAL AYARLAR
     ============================================================================ */

  // İlişki vakalarında ikinci kişi zorunlu:
  const SECOND_REQUIRED_TYPES = new Set(["geri_getirme", "baglama", "aile_engeli"]);

  // Minimum çıktı uzunluğu (karakter)
  const MIN_CHARS = 3200; // 3000+ garantisi için 3200 seçildi

  // Basit stopword listesi (anahtar kelime çıkarmada)
  const STOPWORDS = new Set([
    "hocam","selam","selamünaleyküm","aleyküm","merhaba","hayırlı","akşamlar","sabah",
    "ben","bana","beni","biz","siz","sizin","benim","sen","sana","o","onu","ona","onun",
    "ve","ile","ama","fakat","çünkü","da","de","ki","mi","mı","mu","mü","bir","bu","şu","o",
    "çok","daha","artık","gibi","olarak","şey","yani","neden","nasıl","lütfen","inşallah",
    "allah","razı","olsun","tamam","evet","hayır","oldu","olur","olsun","gör","bak","dönüş",
    "bekliyorum","bekle","yok","var","şuan","şimdi","sonra","kardeşim","abi","abla",
    "www","http","https","com","net"
  ]);

  /* ============================================================================
     UI: 2. Şahıs zorunluluk vurgusu
     ============================================================================ */
  function toggleSecondRequirementUI() {
    const islemTuru = document.getElementById("islemTuru").value;
    const i1 = document.getElementById("ekIsim");
    const i2 = document.getElementById("ekAnneAdi");

    i1.classList.remove("required-ring");
    i2.classList.remove("required-ring");

    if (SECOND_REQUIRED_TYPES.has(islemTuru)) {
      if (!i1.value.trim()) i1.classList.add("required-ring");
      if (!i2.value.trim()) i2.classList.add("required-ring");
    }
  }

  document.getElementById("islemTuru").addEventListener("change", toggleSecondRequirementUI);
  document.getElementById("ekIsim").addEventListener("input", toggleSecondRequirementUI);
  document.getElementById("ekAnneAdi").addEventListener("input", toggleSecondRequirementUI);

  /* ============================================================================
     UTIL: metin düzenleme
     ============================================================================ */
  function safeTrim(s) { return (s || "").replace(/\s+/g, " ").trim(); }
  function capFirst(s) {
    const t = safeTrim(s);
    return t ? (t.charAt(0).toUpperCase() + t.slice(1).toLowerCase()) : "";
  }

  function stripLinksAndMeta(text) {
    let t = text || "";
    t = t.replace(/https?:\/\/\S+/g, " ");
    t = t.replace(/\[[^\]]+\]/g, " ");
    t = t.replace(/\b\w+5000\b/g, " ");
    t = t.replace(/\s+/g, " ");
    return t.trim();
  }

  function normalizeForAnalysis(text) {
    return stripLinksAndMeta(text).toLocaleLowerCase("tr-TR");
  }

  /* ============================================================================
     UTIL: konuşmadan anahtar kelime (rapor gibi değil, doğal yedirme)
     ============================================================================ */
  function extractKeyPhrases(raw) {
    const t = normalizeForAnalysis(raw);
    const words = (t.match(/[a-zçğıöşü]{4,}/g) || []);
    const freq = new Map();
    for (const w of words) {
      if (STOPWORDS.has(w)) continue;
      freq.set(w, (freq.get(w) || 0) + 1);
    }
    return Array.from(freq.entries())
      .sort((a,b) => b[1] - a[1])
      .slice(0, 6)
      .map(x => x[0])
      .slice(0, 3);
  }

  function weavePhrases(phrases) {
    if (!phrases || !phrases.length) return "";
    const p = phrases.filter(Boolean);
    if (!p.length) return "";
    // “rapor gibi” tırnak içinde yapmıyoruz; doğal kullanıyoruz:
    return `Konuşmanızdaki ${p.join(", ")} gibi detaylar da bu tablonun hayatınıza nasıl yansıdığını zaten gösteriyor. `;
  }

  /* ============================================================================
     ANALİZ: Büyü türü kütüphanesi (pattern + ağırlık)
     - İstenen işlem türü, skora küçük bonus verir
     ============================================================================ */
  function scorePatterns(text, patterns) {
    let score = 0;
    for (const p of patterns) {
      if (p.re.test(text)) score += p.w;
    }
    return score;
  }

  const SPELL_LIBRARY = [
    {
      key: "rizik_kapama",
      name: "rızık kapama büyüsü",
      hintTypes: ["rizik_acma", "genel", "evrak_yol"],
      patterns: [
        { re: /iş bulamıyorum|işsiz|iş yok|işe giremiyorum/i, w: 10 },
        { re: /borç|icra|kredi|ödeyemiyorum|masraf/i, w: 9 },
        { re: /zor durum|maddi|para yetmiyor|geçinemiyorum/i, w: 8 },
        { re: /bereket yok|para tutmuyor|kazanç düştü|kazancım yok/i, w: 7 },
        { re: /tek başıma|yalnızım|kızı?mla yaşıyorum|çocuğumla/i, w: 4 }
      ]
    },
    {
      key: "kismet_kapama",
      name: "kısmet kapama büyüsü",
      hintTypes: ["kismet_acma", "genel"],
      patterns: [
        { re: /kısmet|talip|evlenemiyorum|kimse çıkmıyor|kısmetim kapalı/i, w: 10 },
        { re: /son anda bozuluyor|tam olacakken bozuldu|hep yarım kalıyor/i, w: 8 },
        { re: /nişan bozuldu|söz bozuldu|evlilik iptal/i, w: 6 }
      ]
    },
    {
      key: "sogutma_ayirma",
      name: "soğutma ve ayırma büyüsü",
      hintTypes: ["geri_getirme", "baglama", "genel", "aile_engeli"],
      patterns: [
        { re: /soğudum|soğudu|içimden gelmiyor|bitti|istemiyorum/i, w: 10 },
        { re: /ayrıldık|boşanmak|terk etti|gitti geri gelmedi/i, w: 10 },
        { re: /engelledi|blokladı|mesajlara bakmıyor|görmüyor/i, w: 9 },
        { re: /kavga|tartışma|sürekli sorun|yüksek ses/i, w: 5 }
      ]
    },
    {
      key: "aile_engeli",
      name: "aile engeli büyüsü",
      hintTypes: ["aile_engeli", "geri_getirme", "baglama", "genel"],
      patterns: [
        { re: /aile|anne|baba|abi|abla|kardeş/i, w: 6 },
        { re: /izin vermiyor|karşı çıkıyor|engel oluyor|kabul etmiyor|istemiyorlar/i, w: 12 },
        { re: /evlilik|nişan|yuva/i, w: 6 }
      ]
    },
    {
      key: "yol_evrak_kilidi",
      name: "yol ve evrak kilidi büyüsü",
      hintTypes: ["evrak_yol", "genel", "rizik_acma"],
      patterns: [
        { re: /vize|vatandaşlık|oturum/i, w: 12 },
        { re: /başvuru|dosya|evrak|mahkeme/i, w: 10 },
        { re: /haber yok|bekliyorum|sonuç gelmedi|uzadı|bekliyo/i, w: 12 }
      ]
    },
    {
      key: "fitne_soz",
      name: "fitne ve söz taşıma büyüsü",
      hintTypes: ["geri_getirme", "baglama", "aile_engeli", "genel"],
      patterns: [
        { re: /dedikodu|laf taşı|söz götür|dolduruyor/i, w: 12 },
        { re: /çevresi|arkadaşları|birileri|biri dedi/i, w: 8 },
        { re: /iftira|yalan|yanlış anladı|yanlış biliyor/i, w: 8 }
      ]
    }
  ];

  function detectSpellByConversation(rawLog, islemTuru) {
    const t = normalizeForAnalysis(rawLog);
    let best = { key: "sogutma_ayirma", name: "soğutma ve ayırma büyüsü", score: 0 };

    for (const s of SPELL_LIBRARY) {
      let sc = scorePatterns(t, s.patterns);
      if (s.hintTypes.includes(islemTuru)) sc += 3; // küçük bonus
      if (sc > best.score) best = { key: s.key, name: s.name, score: sc };
    }

    // hiçbir şey yakalayamazsa işlem türüne göre default
    if (best.score === 0) {
      if (islemTuru === "rizik_acma") return { key: "rizik_kapama", name: "rızık kapama büyüsü", score: 1 };
      if (islemTuru === "kismet_acma") return { key: "kismet_kapama", name: "kısmet kapama büyüsü", score: 1 };
      if (islemTuru === "evrak_yol") return { key: "yol_evrak_kilidi", name: "yol ve evrak kilidi büyüsü", score: 1 };
      if (islemTuru === "aile_engeli") return { key: "aile_engeli", name: "aile engeli büyüsü", score: 1 };
      return { key: "sogutma_ayirma", name: "soğutma ve ayırma büyüsü", score: 1 };
    }

    return best;
  }

  /* ============================================================================
     PART-B: DEV BAKIM ŞABLONLARI
     - “Her büyü için ayrı şablon” şartı burada birebir karşılanır.
     - Şablonlar teknik/rapor dili içermez.
     - Metinler uzun ve ikna odaklıdır.
     - Her biri 6 bölüm mantığıyla yazılır.
     ============================================================================ */

  const CARE_TEMPLATES = {

    /* ---------------------------------------------------------
       RIZIK KAPAMA (FULL)
    --------------------------------------------------------- */
    rizik_kapama: {
      intro: (ctx) =>
`${ctx.isim} ${ctx.hitap}, verdiğiniz isimler üzerinden detaylı bir bakım yaptım. Siz “zor durumdayım, iş bulamıyorum” diyorsunuz ya; bu sadece hayatın bir dönemi değil, rızık tarafında önünüze konmuş bir perdeyi gösteriyor. ${weavePhrases(ctx.phrases)} Bu perde insanı çalışsa da karşılık alamaz hâle getirir, niyeti kırar, umutlanınca da tam toparlanacakken geri çeker. Burada net olan şudur: üzerinizde ${ctx.spell.name} var ve bu büyü rızık yolunu daraltıyor.`,

      daily: (ctx) =>
`Bu büyü günlük hayatta kendini belli eder: Birincisi elinize bir şey geçse bile sanki elinizden su gibi akıp gider, tutunamazsınız. İkincisi tam bir kapı açılıyor dersiniz; iş, para, fırsat… ama son anda bozulur ya da uzar, sürüncemede kalır. Üçüncüsü de evin içinde bile zihniniz rahat etmez; “ben ne yapacağım” baskısı üstünüze çöker. Bu hâl tembellik değil, şanssızlık hiç değil; rızık tarafında bir kilit olduğu zaman insanın hayatı böyle döner.`,

      tie: (ctx) =>
`Konuşmalarınızın akışında yük çok net: tek başınıza ayakta kalma çabası, geçim derdi, üst üste gelen masraf baskısı. Bu durum insanın moralini kırar ve insanı “benim kaderim bu mu” noktasına getirir. Hayır, kader diye kabul edilecek bir şey değil. Bu işin düğümü rızık tarafında. Düğüm çözüldüğünde aynı hayatın içinde bile rahatlama başlar, çünkü engel kalkmış olur.`,

      promise: (ctx) =>
`Allah’ın izniyle üzerinizde görünen ${ctx.spell.name} kesin ve kalıcı şekilde bozulur. Bu bozulma geçici bir rahatlama değildir; kökten bir çözülmedir. Büyü bozulduğunda rızık tarafındaki tıkanıklık açılır, kazanç ve fırsat yolu hareketlenir, borç baskısı hafifler. Siz “ben nefes almak istiyorum” diyorsunuz ya; bu nefes Allah’ın izniyle geri gelir.`,

      process: (ctx) =>
`Süreç disiplinli yürür: İlk gün temel uygulama yapılır ve önemli kısımlar video kaydıyla size gönderilir. Ardından 7 gün boyunca size özel okuma yapılır. 3–5 gün içinde iç sıkışıklık azalır, haberler ve fırsatlar daha hızlı akmaya başlar. 7. gün itibarıyla rızık tarafında belirgin bir açılma görülür. Bu süreçte aynı anda başka bir hocayla görüşmeyin; farklı uygulamalar niyeti dağıtır, işi geciktirir. Tek çizgide ilerlediğimizde sonuç temiz olur.`,

      past: (ctx) =>
`Benzer rızık sıkışıklığı yaşayan bir danışanımda da aynı şekilde ilerledik: ilk günlerde sadece iç ferahlama oldu, 4. gün civarı bir iş haberi geldi, 7. gün itibarıyla kazanç tarafında toparlanma başladı. Bu tarz düğümler doğru yerden çözülünce Allah’ın izniyle kalıcı sonuç verir.`,

      close: (ctx) =>
`Buradan sonrası kararlılık meselesi. Niyetiniz netse bu süreci başından sonuna aynı disiplinle yürütürüz ve işi yarım bırakmadan kapatırız. Çalışma rahmani usullerle yürütülür (uygulama için gereken hazırlıklar sebebiyle belirli bir bedel oluşur). Nasıl ilerlemek istediğinizi söylemeniz yeterlidir.`
    },

    /* ---------------------------------------------------------
       KISMET KAPAMA (FULL)
    --------------------------------------------------------- */
    kismet_kapama: {
      intro: (ctx) =>
`${ctx.isim} ${ctx.hitap}, verdiğiniz isimler üzerinden detaylı bir bakım yaptım. Kısmet tarafında “olacak gibi olup olmama” döngüsü var ve bu döngü insanı bekletir, yorar, hevesi kırar. ${weavePhrases(ctx.phrases)} Burada net olan şudur: üzerinizde ${ctx.spell.name} var. Bu büyü, hayırlı görünen yolları son anda kapatır, niyeti dağıtır ve yuva kurma işini ağırlaştırır.`,

      daily: (ctx) =>
`Bu büyü günlük hayatta üç şekilde belli olur: Birincisi talip çıkacak gibi olur ama son anda geri çekilir ya da konu dağılır. İkincisi siz ciddi bir adım atmaya niyet edersiniz ama hep bir “aksilik” çıkar, sanki önünüzde görünmez bir kapı kapanır. Üçüncüsü de içinizde sürekli bir tedirginlik olur; “neden benim işim olmuyor” sorusu zihni kemirir. Bunlar tesadüf değil; kısmet kapama büyüsünün hayat üzerindeki izi böyledir.`,

      tie: (ctx) =>
`Konuşmalarınızın içinde bekleyiş ve sabır var; ama sabrın karşılığının gelmemesi sizi yormuş. Bu yorgunluk insanı yanlış kararlar almaya da itebilir. Bu yüzden önce düğüm çözülür. Düğüm çözüldüğünde hem kalp ferahlar hem yol açılır. Kısmet işi, yol açılmadan düzelmez. Burada hedef net: sizin yolunuz açılacak, hayırlı yuva niyeti önündeki perde kalkacak.`,

      promise: (ctx) =>
`Allah’ın izniyle üzerinizde görünen ${ctx.spell.name} kesin ve kalıcı şekilde bozulur. Bu büyü bozulduğunda kısmet kapısı açılır, talip ve yuva tarafı netleşir. Siz “benim de hayırlı bir düzenim olsun” diyorsunuz ya; bu düzenin yolu Allah’ın izniyle açılır.`,

      process: (ctx) =>
`Süreç şöyle yürür: İlk gün temel uygulama yapılır ve önemli kısımlar video kaydıyla size gönderilir. 7 gün boyunca size özel okumalar yapılır. 3–5 gün içinde ruh hâlinde ferahlama, niyette netleşme başlar. 7. gün itibarıyla kısmet tarafında belirgin bir açılma görülür. Bu süreçte başka bir hocayla aynı anda ilerlemeyin; farklı uygulamalar birbiriyle karışır, işi uzatır.`,

      past: (ctx) =>
`Geçmişte benzer kısmet sıkışıklığı yaşayan bir danışanımda; 5. gün civarı beklemediği yerden bir tanışma oldu, 7. gün itibarıyla konu ciddi zemine oturdu. Bu iş doğru çizgide yürüdüğünde Allah’ın izniyle kalıcı sonuç verir.`,

      close: (ctx) =>
`Buradan sonrası artık karar meselesi. Siz niyetinizi net tutun; biz de süreci disiplinli şekilde yürütürüz. Çalışma rahmani usullerle yürütülür (uygulama için gereken hazırlıklar sebebiyle belirli bir bedel oluşur). Nasıl ilerlemek istediğinizi söylemeniz yeterlidir.`
    },

    /* ---------------------------------------------------------
       SOĞUTMA ve AYIRMA (FULL)
    --------------------------------------------------------- */
    sogutma_ayirma: {
      intro: (ctx) =>
`${ctx.isim} ${ctx.hitap}, verdiğiniz isimler üzerinden detaylı bir bakım yaptım. İlişki tarafında yaşanan kopuş, soğuma veya bir anda mesafenin artması “iki kişinin basit anlaşmazlığı” değil; araya konmuş bir ayırmanın işaretidir. ${weavePhrases(ctx.phrases)} Burada net olan şudur: üzerinizde ${ctx.spell.name} var ve bu büyü iki kişi arasındaki muhabbeti zayıflatıp dili değiştirir.`,

      daily: (ctx) =>
`Bu büyü günlük hayatta kendini şöyle gösterir: Bir gün konuşma olur, ertesi gün duvar gibi olur. Sebepsiz yere tartışma çıkar, en küçük söz büyür, “içimden gelmiyor” gibi cümleler çoğalır. Karşı taraf bazen kendi içinde de çelişir; yaklaşmak ister ama geri çekilir. Siz de doğal olarak yıpranırsınız. Bu hâl normal değil; soğutma ve ayırma büyüsü ilişkiye böyle iz bırakır.`,

      tie: (ctx) =>
`Konuşmalarınızda kırılma hissi var: siz bir şeyleri toparlamak istiyorsunuz ama sanki arada görünmez bir duvar var. Bu duvar, konuşmayla yıkılmaz. Önce büyü bozulur; büyü bozulduğunda dil yumuşar, tavır yumuşar, adım atmak kolaylaşır. Burada hedef nettir: kopan bağ toparlanacak, muhabbet yeniden canlanacak ve ilişki zeminine oturacaktır.`,

      promise: (ctx) =>
`Allah’ın izniyle üzerinizde görünen ${ctx.spell.name} kesin ve kalıcı şekilde bozulur. Bu bozulma ile birlikte araya giren soğukluk dağılır, iletişim tekrar açılır, karşı tarafın tavrı netleşir. Bu iş “biraz düzelir” değil; büyü kökten kalktığı için kalıcı şekilde düzelir.`,

      process: (ctx) =>
`Süreç disiplinli yürür: İlk gün temel uygulama yapılır ve önemli kısımlar video kaydıyla size gönderilir. 7 gün boyunca size özel okuma yapılır. 3–5 gün içinde yumuşama başlar; konuşma isteği, özlem, merak gibi işaretler görülür. 7. gün itibarıyla net bir dönüş ve toparlanma oluşur. Bu süreçte başka bir hocayla aynı anda ilerlemeyin; farklı uygulamalar niyeti dağıtır, sonucu geciktirir.`,

      past: (ctx) =>
`Benzer soğuma yaşayan bir danışanımda; 3. gün mesaj geldi, 5. gün konuşma uzadı, 7. gün itibarıyla ilişki yeniden zemine oturdu. Bu tür vakalar doğru çizgide yürütüldüğünde Allah’ın izniyle kalıcı sonuç verir.`,

      close: (ctx) =>
`Buradan sonrası kararlılık meselesi. Niyetiniz netse bu süreci başından sonuna disiplinle yürütür, işi yarım bırakmadan kapatırız. Çalışma rahmani usullerle yürütülür (uygulama için gereken hazırlıklar sebebiyle belirli bir bedel oluşur). Nasıl ilerlemek istediğinizi söylemeniz yeterlidir.`
    },

    /* ---------------------------------------------------------
       AİLE ENGELİ (FULL)
    --------------------------------------------------------- */
    aile_engeli: {
      intro: (ctx) =>
`${ctx.isim} ${ctx.hitap}, verdiğiniz isimler üzerinden detaylı bir bakım yaptım. Aile tarafında görülen sertlik, sürekli karşı çıkma ve “ne olursa olsun olmaz” hâli çoğu zaman sadece fikir ayrılığı değildir; burada iradeyi etkileyen bir engel vardır. ${weavePhrases(ctx.phrases)} Burada net olan şudur: üzerinizde ${ctx.spell.name} var ve bu büyü yuva niyetinin önüne duvar örüyor.`,

      daily: (ctx) =>
`Bu büyü günlük hayatta kendini şöyle belli eder: Aile konuşmaları yumuşamaz, her deneme sertleşir. Konu açılınca bir anda tansiyon yükselir, sanki aynı cümleler tekrar eder. Sizin niyetiniz düzgün olsa bile “hep bir bahane” çıkar. Bu durum normal değildir; aile engeli büyüsü konuşmanın yönünü böyle kilitler.`,

      tie: (ctx) =>
`Konuşmalarınızın genel çizgisi, aile tarafında direnç olduğunu gösteriyor. Bu direnç bazen sebepsiz büyür, bazen de küçük bir mesele büyütülür. Bu işin düğümü aile iradesinde. Düğüm çözülmeden “hadi konuşalım” demek çoğu zaman işe yaramaz. Önce engel kalkar; engel kalkınca aile tarafında yumuşama başlar, kabule giden kapı açılır. Hedef nettir: sizin yolunuz açılacak ve aile tarafı yumuşayacaktır.`,

      promise: (ctx) =>
`Allah’ın izniyle üzerinizde görünen ${ctx.spell.name} kesin ve kalıcı şekilde bozulur. Bu büyü bozulduğunda ailenin dili yumuşar, inat kırılır, konuşma zemini oluşur. Siz “yuvam olsun” diyorsunuz ya; bu yuva niyeti Allah’ın izniyle önündeki engelden kurtulur ve yol açılır.`,

      process: (ctx) =>
`Süreç disiplinli yürür: İlk gün temel uygulama yapılır ve önemli kısımlar video kaydıyla size gönderilir. 7 gün boyunca size özel okuma yapılır. 3–5 gün içinde ev içi gerginlik azalır, konuşmalar daha sakinleşir. 7. gün itibarıyla aile tarafında net bir yumuşama görülür. Bu süreçte başka bir hocayla aynı anda ilerlemeyin; farklı uygulamalar niyeti dağıtır, sonucu geciktirir.`,

      past: (ctx) =>
`Benzer aile engeli yaşayan bir danışanımda; 5. gün konuşma sertliği kırıldı, 7. gün itibarıyla aile “tamam bir konuşalım” dedi. Bu çizgide yürüdüğümüzde Allah’ın izniyle sonuç kalıcı olur.`,

      close: (ctx) =>
`Buradan sonrası karar meselesi. Siz niyetinizi net tutun; biz de süreci disiplinli şekilde yürütürüz. Çalışma rahmani usullerle yürütülür (uygulama için gereken hazırlıklar sebebiyle belirli bir bedel oluşur). Nasıl ilerlemek istediğinizi söylemeniz yeterlidir.`
    },

    /* ---------------------------------------------------------
       YOL / EVRAK KİLİDİ (FULL)
    --------------------------------------------------------- */
    yol_evrak_kilidi: {
      intro: (ctx) =>
`${ctx.isim} ${ctx.hitap}, verdiğiniz isimler üzerinden detaylı bir bakım yaptım. Dosyanın uzaması, haberin gelmemesi ve bekleyişin artması çoğu zaman sadece “yoğunluk” değildir; yol ve evrak tarafında bir kilit olur. ${weavePhrases(ctx.phrases)} Burada net olan şudur: üzerinizde ${ctx.spell.name} var ve bu büyü süreci yerinde saydırır.`,

      daily: (ctx) =>
`Bu büyü günlük hayatta şunu yapar: İnsan sürekli bekler, “bugün gelir mi” diye takip eder ama sonuç gelmez. İkincisi, sanki hep son adımda takılır; evrak tamamlanır ama cevap gecikir. Üçüncüsü, bu bekleyiş insanın içini daraltır; uykuyu, huzuru bozar. Bu bir kader değil; yol kilidi olduğu zaman hayat böyle ağırlaşır.`,

      tie: (ctx) =>
`Konuşmalarınızdan görünen en net şey: haber bekleyişi ve bu bekleyişin sizi yorması. Düğüm burada. Bu düğüm çözülmeden “hadi hızlansın” demek çoğu zaman işe yaramaz. Önce kilit kalkar; kilit kalkınca haber yolu açılır, süreç hareketlenir. Hedef nettir: haber gelecek ve yol açılacaktır.`,

      promise: (ctx) =>
`Allah’ın izniyle üzerinizde görünen ${ctx.spell.name} kesin ve kalıcı şekilde bozulur. Bu büyü bozulduğunda dosya tarafındaki ağırlık kalkar, süreç hızlanır ve haber gelir. Bu iş yarım kalmaz; kilit kalktığı için sonuç kalıcı şekilde yoluna girer.`,

      process: (ctx) =>
`Süreç disiplinli yürür: İlk gün temel uygulama yapılır ve önemli kısımlar video kaydıyla size gönderilir. 7 gün boyunca size özel okuma yapılır. 3–5 gün içinde bekleyiş baskısı hafifler, haber tarafında hareketlenme başlar. 7. gün itibarıyla net bir açılma görülür. Bu süreçte başka bir hocayla aynı anda ilerlemeyin; farklı uygulamalar niyeti dağıtır, sonucu geciktirir.`,

      past: (ctx) =>
`Benzer evrak tıkanıklığı yaşayan bir danışanımda; 4. gün süreçten haber geldi, 7. gün itibarıyla dosya açıldı ve yoluna girdi. Bu çizgide yürütülen işler Allah’ın izniyle kalıcı sonuç verir.`,

      close: (ctx) =>
`Buradan sonrası kararlılık meselesi. Niyetiniz netse bu süreci baştan sona disiplinle yürütür, işi yarım bırakmadan kapatırız. Çalışma rahmani usullerle yürütülür (uygulama için gereken hazırlıklar sebebiyle belirli bir bedel oluşur). Nasıl ilerlemek istediğinizi söylemeniz yeterlidir.`
    },

    /* ---------------------------------------------------------
       FITNE / SÖZ TAŞIMA (FULL)
    --------------------------------------------------------- */
    fitne_soz: {
      intro: (ctx) =>
`${ctx.isim} ${ctx.hitap}, verdiğiniz isimler üzerinden detaylı bir bakım yaptım. İlişki ya da aile içinde söz taşınması, yanlış anlaşılmaların artması ve yön değişmeler fitnenin güçlendiğini gösterir. ${weavePhrases(ctx.phrases)} Burada net olan şudur: üzerinizde ${ctx.spell.name} var ve bu büyü iki tarafın zihnini bulandırır.`,

      daily: (ctx) =>
`Bu büyü günlük hayatta şunu yapar: Bir söz büyür, bir cümle yanlış anlaşılır, küçük mesele devleşir. Birileri araya girer, konuşmaların yönünü değiştirir, “o öyle dedi” gibi cümleler çoğalır. İkincisi, sizin iyi niyetiniz bile yanlış görülür. Üçüncüsü, ilişki veya aile içinde güven hissi zayıflar. Bu tesadüf değil; fitne büyüsü böyle iz bırakır.`,

      tie: (ctx) =>
`Konuşmalarınızın içinde yön değiştiren bir hava var: bazen iyi giden şey bir anda bozuluyor. Bu tür bozulmaların kökü çoğu zaman araya giren sözlerdir. Söz taşıma büyüsü bozulmadan ortam kolay kolay durulmaz. Önce bu düğüm çözülür; sonra konuşmalar netleşir, yanlış anlamalar biter. Hedef nettir: fitne kalkacak ve ilişki/aile zemini toparlanacaktır.`,

      promise: (ctx) =>
`Allah’ın izniyle üzerinizde görünen ${ctx.spell.name} kesin ve kalıcı şekilde bozulur. Bu büyü bozulduğunda sözlerin etkisi kırılır, kafalar berraklaşır, iletişim düzene girer. Bu iş “biraz sakinleşme” değil; fitne kökten kalktığı için kalıcı şekilde düzelir.`,

      process: (ctx) =>
`Süreç disiplinli yürür: İlk gün temel uygulama yapılır ve önemli kısımlar video kaydıyla size gönderilir. 7 gün boyunca size özel okuma yapılır. 3–5 gün içinde ortam yumuşamaya başlar, konuşmalar daha netleşir. 7. gün itibarıyla fitnenin ağırlığı kırılır, ilişki/aile daha sakin bir zemine oturur. Bu süreçte başka bir hocayla aynı anda ilerlemeyin; farklı uygulamalar niyeti dağıtır.`,

      past: (ctx) =>
`Benzer fitne yaşayan bir danışanımda; 3. gün yanlış anlaşılmalar azaldı, 7. gün itibarıyla ortam tamamen duruldu. Bu çizgide yürütülen işler Allah’ın izniyle kalıcı sonuç verir.`,

      close: (ctx) =>
`Buradan sonrası karar meselesi. Niyetiniz netse bu süreci disiplinle yürütür, işi yarım bırakmadan kapatırız. Çalışma rahmani usullerle yürütülür (uygulama için gereken hazırlıklar sebebiyle belirli bir bedel oluşur). Nasıl ilerlemek istediğinizi söylemeniz yeterlidir.`
    }
  };

  /* ============================================================================
     PART-C: ULTRA UZUN METİN DERLEYİCİ
     - 7 bölüm birleştirir
     - Minimum karakter kilidi ile kısa metin çıkmasını engeller
     ============================================================================ */

  function buildNoOtherHocaNote() {
    // Kullanıcı istedi: danışanın başka hocayla aynı anda ilerlememesi mantıklı gerekçeyle belirtilsin
    return `Bu süreçte aynı anda başka bir hocayla ilerlemeyin; farklı uygulamalar birbiriyle karışır, niyeti dağıtır ve sonucu geciktirir. Bu iş tek elde, tek niyetle yürüdüğünde hızlı ve temiz sonuç verir.`;
  }

  function buildExtraPadding(ctx) {
    // Metin kısa kalırsa eklenecek “doğal uzatma” paragrafları (teknik değil)
    return [
      `Şunu da açık söyleyeyim: Bu tür büyüler insana bazen “sanki her şey kendiliğinden böyle” hissini verir. Ama düğüm çözüldüğünde aynı hayatın içinde bile akış değişir; çünkü engel kalkmış olur.`,
      `Bu yüzden süreci baştan sona disiplinli yürütmek önemlidir. Yarım bırakılan iş düğümü tam çözmediği için kişiyi tekrar aynı yere çekebilir. Biz yarım bırakmayız; işi neticelendirip kapatırız.`,
      `Siz niyetinizi net tutun. Biz de gereken düzeni kurar, okumaları aynı çizgide yürütürüz. Allah’ın izniyle sonuç kalıcı şekilde ortaya çıkar.`
    ].join("\n\n");
  }

  function enforceMinChars(text, ctx) {
    if (text.length >= MIN_CHARS) return text;

    let out = text + "\n\n" + buildExtraPadding(ctx);
    while (out.length < MIN_CHARS) {
      out += "\n\n" + buildExtraPadding(ctx);
      if (out.length > MIN_CHARS + 900) break; // aşırı şişirmeyi sınırlıyoruz
    }
    return out;
  }

  function chooseTemplateKey(spellKey) {
    // spellKey library’den gelir; CARE_TEMPLATES anahtarlarıyla eşleştiriyoruz
    if (CARE_TEMPLATES[spellKey]) return spellKey;
    return "sogutma_ayirma";
  }

  function buildCareText(ctx) {
    const key = chooseTemplateKey(ctx.spell.key);
    const tpl = CARE_TEMPLATES[key];

    // 7 bölüm:
    const intro   = tpl.intro(ctx);
    const daily   = tpl.daily(ctx);
    const tie     = tpl.tie(ctx);
    const promise = tpl.promise(ctx);
    const process = tpl.process(ctx);
    const past    = tpl.past(ctx);
    const note    = buildNoOtherHocaNote();
    const close   = tpl.close(ctx);

    const full = [
      intro,
      daily,
      tie,
      promise,
      process,
      past,
      note,
      close
    ].join("\n\n");

    return enforceMinChars(full, ctx);
  }

  /* ============================================================================
     Loading helpers
     ============================================================================ */
  function showLoading() {
    document.getElementById("loadingBox").classList.remove("hidden");
    document.getElementById("dot1").classList.remove("active");
    document.getElementById("dot2").classList.remove("active");
    document.getElementById("dot3").classList.remove("active");
  }
  function hideLoading() {
    document.getElementById("loadingBox").classList.add("hidden");
  }
  function stepLoading(n) {
    if (n === 1) document.getElementById("dot1").classList.add("active");
    if (n === 2) document.getElementById("dot2").classList.add("active");
    if (n === 3) document.getElementById("dot3").classList.add("active");
  }

  /* ============================================================================
     MAIN: Analizi başlat (V9.2)
     ============================================================================ */
  function analiziBaslatV92() {
    const isimRaw   = safeTrim(document.getElementById("isim").value);
    const anneRaw   = safeTrim(document.getElementById("anneAdi").value);
    const karsiRaw  = safeTrim(document.getElementById("ekIsim").value);
    const kAnneRaw  = safeTrim(document.getElementById("ekAnneAdi").value);
    const rawLog    = safeTrim(document.getElementById("hikayeLog").value);
    const islemTuru = document.getElementById("islemTuru").value;
    const hitap     = document.querySelector('input[name="hitap"]:checked').value;

    if (!isimRaw || !rawLog) {
      alert("Danışan adı ve WhatsApp konuşması zorunludur.");
      return;
    }

    // İlişki vakalarında 2. kişi zorunlu kontrol:
    if (SECOND_REQUIRED_TYPES.has(islemTuru)) {
      if (!karsiRaw || !kAnneRaw) {
        toggleSecondRequirementUI();
        alert("Bu işlem türü için muhatap adı ve muhatap anne adı zorunludur.");
        return;
      }
    }

    // UI: hide result, show loading
    document.getElementById("sonucAlani").classList.add("hidden");
    showLoading();
    stepLoading(1);

    // Analiz hissi için 3 aşamalı gecikme
    setTimeout(() => {
      stepLoading(2);

      setTimeout(() => {
        stepLoading(3);

        setTimeout(() => {
          const ctx = {
            isim: capFirst(isimRaw),
            hitap,
            anne: capFirst(anneRaw),
            karsi: capFirst(karsiRaw),
            kAnne: capFirst(kAnneRaw),
            islemTuru,
            rawLog,
            phrases: extractKeyPhrases(rawLog),
            spell: detectSpellByConversation(rawLog, islemTuru)
          };

          const finalText = buildCareText(ctx);

          document.getElementById("analizMetni").innerText = finalText;
          hideLoading();
          document.getElementById("sonucAlani").classList.remove("hidden");
          document.getElementById("sonucAlani").scrollIntoView({ behavior: "smooth" });
        }, 900);

      }, 900);

    }, 900);
  }

  /* ============================================================================
     Copy
     ============================================================================ */
  function kopyalaMetin() {
    const t = document.getElementById("analizMetni").innerText || "";
    if (!t) return alert("Önce metni oluşturun.");
    navigator.clipboard.writeText(t)
      .then(() => alert("Metin kopyalandı."))
      .catch(() => alert("Kopyalama başarısız."));
  }

  /* ============================================================================
     WhatsApp gönder (numaraya)
     ============================================================================ */
  function whatsappPaylasV92() {
    const t = document.getElementById("analizMetni").innerText || "";
    let no = (document.getElementById("telNo").value || "").replace(/\D/g, "");

    if (!t || t.length < 600) {
      alert("Önce bakım metnini oluşturun.");
      return;
    }

    // Numara yoksa genel paylaş
    if (no.length < 10) {
      window.open(`https://wa.me/?text=${encodeURIComponent(t)}`, "_blank");
      return;
    }

    // Türkiye format
    if (!no.startsWith("90")) {
      no = "90" + (no.startsWith("0") ? no.substring(1) : no);
    }

    window.open(`https://wa.me/${no}?text=${encodeURIComponent(t)}`, "_blank");
  }
  </script>
</body>
</html>
